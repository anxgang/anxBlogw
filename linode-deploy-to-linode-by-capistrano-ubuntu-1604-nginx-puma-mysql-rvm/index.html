<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.24.0 by Michael Rose
  Copyright 2013-2020 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->
<html lang="zh" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>[Linode] Deploy Rails app to Linode by Capistrano ( Ubuntu 16.04/nginx/puma/MySQL/rvm ) - ANxGANG</title>
<meta name="description" content="Ubuntu 16.04 / Ruby 2.3.1 / Rails 5.0.0   Create a Linode    plan:   Ubuntu 16.04 LTS Disk        256MB Swap Image      login user:   root 123456   ssh to remote side and build environment  $ ssh root@xxx.xxx.xxx.xxx #=&gt;  Linode &gt; dashboard &gt; remote access   1) update all packages  $ sudo apt-get -y update;sudo apt-get -y upgrade;sudo apt-get -y autoremove;   2) setup time zone  $ sudo dpkg-reconfigure or  $ sudo timedatectl set-timezone Asia/Taipei   3) Generate locales  $ sudo locale-gen zh_TW zh_TW.UTF-8 zh_CN.UTF-8 en_US.UTF-8;   4) install MySQL  setup root pw: 1234    $ sudo debconf-set-selections &lt;&lt;&lt; &#39;mysql-server mysql-server/root_password password 1234&#39;;sudo debconf-set-selections &lt;&lt;&lt; &#39;mysql-server mysql-server/root_password_again password 1234&#39;;sudo apt-get -y install mysql-server mysql-common mysql-client libmysqlclient-dev;   5) install necessary packages  	$ sudo apt-get install -y build-essential git-core bison openssl libreadline6-dev curl zlib1g zlib1g-dev libssl-dev libyaml-dev libsqlite3-0 libsqlite3-dev sqlite3  autoconf libc6-dev libpcre3-dev curl libcurl4-nss-dev libxml2-dev libxslt-dev imagemagick nodejs libffi-dev   6) install rvm &amp; ruby 2.3.1  $ sudo \curl -sSL https://get.rvm.io | bash;source ~/.rvm/scripts/rvm;rvm install 2.3.1;      if Mac $ sudo \curl -sSL https://get.rvm.io | bash;source /etc/profile.d/rvm.sh;rvm install 2.3.1;   7) install nginx  $ sudo apt-get -y install nginx;   8) install Rails &amp; bundler  $ gem install rails -v &#39;5.0.0&#39; -V --no-ri --no-rdoc;gem install bundler -V --no-ri --no-rdoc;   check your settings  $ date # Wed Aug  6 10:05:17 CST 2016  $ rvm list # =* ruby-2.3.1  $ ruby -v # ruby 2.3.1  $ rails -v # Rails 5.0.0  $ nginx -v # nginx version: nginx/1.4.6 (Ubuntu)  $ mysql -u root -p # enter pw 1234， there will goes `mysql&gt;`， and you can type `exit` to leave   Create database  1) login  $ mysql -u root -p   2) create database  ( replace YOUR_DATABASE_NAME  )  mysql&gt; create database YOUR_DATABASE_NAME default character set utf8mb4;   3) make a check  mysql&gt; show databases;   setup Nginx symlinks (linked to your project)  1) delete default setting  $ sudo rm /etc/nginx/sites-enabled/default   2) add our symlink  ( replace YOUR_PEOJECT_NAME  )  $ sudo ln -nfs &quot;/home/deploy/YOUR_PROJECT_NAME/current/config/nginx.conf&quot; &quot;/etc/nginx/sites-enabled/YOUR_PROJECT_NAME&quot;   3) make a check  $ ls -la /etc/nginx/sites-enabled/ # =&gt;lrwxrwxrwx 1 root root 45 Aug  5 12:06 kixERP -&gt; /home/deploy/YOUR_PROJECT_NAME/current/config/nginx.conf    add a deploy user  1) setup your password (other information you can just enter to pass )  $ adduser deploy   2) Add user deploy to group sudo  $ gpasswd -a deploy sudo   close root login  1) find “PremitRootLogin” , change from yes to no  $ vim /etc/ssh/sshd_config   2) restart ssh service  $ service ssh restart   login by user deploy  1) setup ssh-key login  ssh deploy@xxx.xxx.xxx.xxx &#39;mkdir -p ~/.ssh;cat &gt;&gt; ~/.ssh/authorized_keys&#39; &lt; ~/.ssh/id_rsa.pub      If not work..  Maybe you should login first (ssh deploy@xxx.xxx.xxx.xxx) And answer ‘yes’ to add the host fingerprint to the ~/.ssh/known_hosts Then try again..   2) login  ssh deploy@xxx.xxx.xxx.xxx   ssh-key generate  1) generate ssh-key  $ ssh-keygen   2) copy the public key  $ cat ~/.ssh/id_rsa.pub   3) paste the key into your github or bitbucket     github            SSH and GPG keys           Bitbucket  	 - YOUR_PROJECT_NAME / Settings / Deployment keys   Setup Capistrano  1) setup Gemfile    - gem &#39;sqlite3&#39;   + gem &#39;sqlite3&#39;, group: :development      - # gem &#39;therubyracer&#39;, platforms: :ruby      + gem &#39;therubyracer&#39;, platforms: :ruby      + group :development do   +   gem &#39;capistrano&#39;,         &#39;~&gt; 3.6.0&#39;, require: false   +   gem &#39;capistrano-rvm&#39;,     &#39;~&gt; 0.1&#39;,   require: false   +   gem &#39;capistrano-rails&#39;,   &#39;~&gt; 1.1.7&#39;, require: false   +   gem &#39;capistrano-bundler&#39;, &#39;~&gt; 1.1.4&#39;, require: false   +   gem &#39;capistrano3-puma&#39;,   &#39;~&gt; 1.2.1&#39;, require: false   + end      + group :production do   +   gem &quot;mysql2&quot;   + end   $ bundle install $ cap install   # =&gt; ask for installing other package? no   2) 	modify Capfile  # Load DSL and set up stages require &quot;capistrano/setup&quot; # Include default deployment tasks require &quot;capistrano/deploy&quot;  require &#39;capistrano/rails&#39; require &#39;capistrano/rvm&#39; require &#39;capistrano/bundler&#39; require &#39;capistrano/rails/assets&#39; require &#39;capistrano/rails/migrations&#39; require &#39;capistrano/puma&#39;  # Load custom tasks from `lib/capistrano/tasks` if you have any defined Dir.glob(&quot;lib/capistrano/tasks/*.rake&quot;).each { |r| import r }   3) replace config/deploy.rb  # config valid only for current version of Capistrano  set :repo_url,        &#39;git@github.com: YOUR_GIT_ACCOUNT/YOUR_PROJECT_NAME&#39; set :application,     &#39;YOUR_PROJECT_NAME&#39; set :user,            &#39;deploy&#39; set :puma_threads,    [4, 16] set :puma_workers,    0  # Don&#39;t change these unless you know what you&#39;re doing set :pty,             true set :use_sudo,        false set :stage,           :production set :deploy_via,      :remote_cache set :deploy_to,       &quot;/home/#{fetch(:user)}/#{fetch(:application)}&quot; set :puma_bind,       &quot;unix://#{shared_path}/tmp/sockets/#{fetch(:application)}-puma.sock&quot; set :puma_state,      &quot;#{shared_path}/tmp/pids/puma.state&quot; set :puma_pid,        &quot;#{shared_path}/tmp/pids/puma.pid&quot; set :puma_access_log, &quot;#{release_path}/log/puma.error.log&quot; set :puma_error_log,  &quot;#{release_path}/log/puma.access.log&quot; set :ssh_options,     { forward_agent: true, user: fetch(:user), keys: %w(~/.ssh/id_rsa.pub) } set :puma_preload_app, true set :puma_worker_timeout, nil set :puma_init_active_record, true  # Change to false when not using ActiveRecord   ## Defaults:  # set :scm,           :git # set :branch,        :master # set :format,        :pretty # set :log_level,     :debug # set :keep_releases, 5  ## Linked Files &amp; Directories (Default None): set :linked_files, %w{config/database.yml config/secrets.yml} set :linked_dirs,  %w{bin log tmp/pids tmp/cache tmp/sockets vendor/bundle public/system}  namespace :puma do   desc &#39;Create Directories for Puma Pids and Socket&#39;   task :make_dirs do     on roles(:app) do       execute &quot;mkdir #{shared_path}/tmp/sockets -p&quot;       execute &quot;mkdir #{shared_path}/tmp/pids -p&quot;     end   end  	before :start, :make_dirs end  namespace :deploy do   desc &quot;Make sure local git is in sync with remote.&quot;   task :check_revision do     on roles(:app) do       unless `git rev-parse HEAD` == `git rev-parse origin/master`         puts &quot;WARNING: HEAD is not the same as origin/master&quot;         puts &quot;Run `git push` to sync changes.&quot;       exit     end   end end  desc &#39;Initial Deploy&#39;   task :initial do   on roles(:app) do     before &#39;deploy:restart&#39;, &#39;puma:start&#39;     invoke &#39;deploy&#39;   end end  desc &#39;Restart application&#39;   task :restart do     on roles(:app), in: :sequence, wait: 5 do     invoke &#39;puma:restart&#39;   end end  desc &#39;Upload to shared/config&#39;   task :upload do   on roles (:app) do     upload! &quot;config/database.yml&quot;, &quot;#{shared_path}/config/database.yml&quot;     upload! &quot;config/secrets.yml&quot;,  &quot;#{shared_path}/config/secrets.yml&quot;   end end  before :starting,  :check_revision after  :finishing, :compile_assets after  :finishing, :cleanup after  :finishing, :restart end  desc &quot;Run rake db:seed on a remote server.&quot; task :seed do   on roles (:app) do     within release_path do       with rails_env: fetch(:rails_env) do       	execute :rake, &quot;db:seed&quot;       end     end   end end  # ps aux | grep puma    # Get puma pid # kill -s SIGUSR2 pid   # Restart puma # kill -s SIGTERM pid   # Stop puma   4) modify config/deploy/production.rb  set :stage, :production set :branch, :master  role :app, %w(deploy@xxx.xxx.xxx.xxx) role :web, %w(deploy@xxx.xxx.xxx.xxx) role :db, %w(deploy@xxx.xxx.xxx.xxx)  set :rails_env, &quot;production&quot; set :puma_env, &quot;production&quot; set :puma_config_file, &quot;#{shared_path}/config/puma.rb&quot; set :puma_conf, &quot;#{shared_path}/config/puma.rb&quot;   5) create config/nignx.conf  	upstream puma-YOUR_PROJECT_NAME { 	  server unix:///home/deploy/YOUR_PROJECT_NAME/shared/tmp/sockets/YOUR_PROJECT_NAME-puma.sock; 	 	} 	 	server { 	  listen 80 default_server deferred; 	  # server_name example.com; 	 	  root /home/deploy/YOUR_PROJECT_NAME/current/public; 	  access_log /home/deploy/YOUR_PROJECT_NAME/current/log/nginx.access.log; 	  error_log /home/deploy/YOUR_PROJECT_NAME/current/log/nginx.error.log info; 	 	  location ^~ /assets/ { 	    gzip_static on; 	    expires max; 	    add_header Cache-Control public; 	  } 	 	  try_files $uri/index.html $uri @puma; 	  location @puma { 	    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; 	    proxy_set_header Host $http_host; 	    proxy_redirect off; 	 	    proxy_pass http://puma-YOUR_PROJECT_NAME; 	 	  } 	 	  error_page 500 502 503 504 /500.html; 	  client_max_body_size 10M; 	  keepalive_timeout 10; 	}   6) modify .gitignore  + /config/database.yml + /config/secrets.yml      copy to *.sample            config/database.yml -&gt; config/database.yml.sample       config/secrets.yml -&gt; config/secrets.yml.sample           delete            config/database.yml       config/secrets.yml           7) first commit  $ git add . $ git commit -m &quot;ready to deploy&quot; $ git push origin master   8) add ymls back and modify  * copy   - config/database.yml.sample -&gt; config/database.yml   - config/secrets.yml.sample -&gt; config/secrets.yml   config/database.yml     production:   -  &lt;&lt;: *default   -  database: db/production.sqlite3   +  adapter: mysql2   +  encoding: utf8mb4   +  database: YOUR_PROJECT_NAME   +  pool: 5   +  username: root   +  password:   +  socket: /var/run/mysqld/mysqld.sock   config/secrets.yml   -  secret_key_base: &lt;%= ENV[&quot;SECRET_KEY_BASE&quot;] %&gt; +  secret_key_base: e4a98dd1063a6765xxxxxxx # copy from development or test secret_key_base   First Deploy  1) check deploy  $ cap production deploy:check   if it shows database.yml does not exist, don&#39;t worry about that. just go next step to copy yml.   2) upload database.yml and secrets.yml from ssh( not git )  $ cap production deploy:upload   3) initial deploy  $ cap production deploy:initial   4) rake db:seed  $ cap production seed      Normal deploy       $ git add . $ git commit -m &quot;commit message&quot; $ git push origin master $ cap production deploy	      Open your website  open your site by ip  http://xxx.xxx.xxx.xxx  if failure, just ssh to Server for log  $ ssh deploy@xxx.xxx.xxx.xxx $ tail -f /home/deploy/YOUR_PROJECT_NAME/current/log/production.log      參考        kakas/CapistranoDeployTest                                             [(Mini Course) Deploy Rails Project to Linux Server             Growth School](http://courses.growthschool.com/courses/deploy-rails-project-to-linux-server)                                                                             [Deploying a Rails App on Ubuntu 14.04 with Capistrano, Nginx, and Puma             DigitalOcean](https://www.digitalocean.com/community/tutorials/deploying-a-rails-app-on-ubuntu-14-04-with-capistrano-nginx-and-puma)">


  <meta name="author" content="anxgang">
  
  <meta property="article:author" content="anxgang">
  


<meta property="og:type" content="article">
<meta property="og:locale" content="zh_TW">
<meta property="og:site_name" content="ANxGANG">
<meta property="og:title" content="[Linode] Deploy Rails app to Linode by Capistrano ( Ubuntu 16.04/nginx/puma/MySQL/rvm )">
<meta property="og:url" content="https://blog.anxgang.com/linode-deploy-to-linode-by-capistrano-ubuntu-1604-nginx-puma-mysql-rvm/">


  <meta property="og:description" content="Ubuntu 16.04 / Ruby 2.3.1 / Rails 5.0.0   Create a Linode    plan:   Ubuntu 16.04 LTS Disk        256MB Swap Image      login user:   root 123456   ssh to remote side and build environment  $ ssh root@xxx.xxx.xxx.xxx #=&gt;  Linode &gt; dashboard &gt; remote access   1) update all packages  $ sudo apt-get -y update;sudo apt-get -y upgrade;sudo apt-get -y autoremove;   2) setup time zone  $ sudo dpkg-reconfigure or  $ sudo timedatectl set-timezone Asia/Taipei   3) Generate locales  $ sudo locale-gen zh_TW zh_TW.UTF-8 zh_CN.UTF-8 en_US.UTF-8;   4) install MySQL  setup root pw: 1234    $ sudo debconf-set-selections &lt;&lt;&lt; &#39;mysql-server mysql-server/root_password password 1234&#39;;sudo debconf-set-selections &lt;&lt;&lt; &#39;mysql-server mysql-server/root_password_again password 1234&#39;;sudo apt-get -y install mysql-server mysql-common mysql-client libmysqlclient-dev;   5) install necessary packages  	$ sudo apt-get install -y build-essential git-core bison openssl libreadline6-dev curl zlib1g zlib1g-dev libssl-dev libyaml-dev libsqlite3-0 libsqlite3-dev sqlite3  autoconf libc6-dev libpcre3-dev curl libcurl4-nss-dev libxml2-dev libxslt-dev imagemagick nodejs libffi-dev   6) install rvm &amp; ruby 2.3.1  $ sudo \curl -sSL https://get.rvm.io | bash;source ~/.rvm/scripts/rvm;rvm install 2.3.1;      if Mac $ sudo \curl -sSL https://get.rvm.io | bash;source /etc/profile.d/rvm.sh;rvm install 2.3.1;   7) install nginx  $ sudo apt-get -y install nginx;   8) install Rails &amp; bundler  $ gem install rails -v &#39;5.0.0&#39; -V --no-ri --no-rdoc;gem install bundler -V --no-ri --no-rdoc;   check your settings  $ date # Wed Aug  6 10:05:17 CST 2016  $ rvm list # =* ruby-2.3.1  $ ruby -v # ruby 2.3.1  $ rails -v # Rails 5.0.0  $ nginx -v # nginx version: nginx/1.4.6 (Ubuntu)  $ mysql -u root -p # enter pw 1234， there will goes `mysql&gt;`， and you can type `exit` to leave   Create database  1) login  $ mysql -u root -p   2) create database  ( replace YOUR_DATABASE_NAME  )  mysql&gt; create database YOUR_DATABASE_NAME default character set utf8mb4;   3) make a check  mysql&gt; show databases;   setup Nginx symlinks (linked to your project)  1) delete default setting  $ sudo rm /etc/nginx/sites-enabled/default   2) add our symlink  ( replace YOUR_PEOJECT_NAME  )  $ sudo ln -nfs &quot;/home/deploy/YOUR_PROJECT_NAME/current/config/nginx.conf&quot; &quot;/etc/nginx/sites-enabled/YOUR_PROJECT_NAME&quot;   3) make a check  $ ls -la /etc/nginx/sites-enabled/ # =&gt;lrwxrwxrwx 1 root root 45 Aug  5 12:06 kixERP -&gt; /home/deploy/YOUR_PROJECT_NAME/current/config/nginx.conf    add a deploy user  1) setup your password (other information you can just enter to pass )  $ adduser deploy   2) Add user deploy to group sudo  $ gpasswd -a deploy sudo   close root login  1) find “PremitRootLogin” , change from yes to no  $ vim /etc/ssh/sshd_config   2) restart ssh service  $ service ssh restart   login by user deploy  1) setup ssh-key login  ssh deploy@xxx.xxx.xxx.xxx &#39;mkdir -p ~/.ssh;cat &gt;&gt; ~/.ssh/authorized_keys&#39; &lt; ~/.ssh/id_rsa.pub      If not work..  Maybe you should login first (ssh deploy@xxx.xxx.xxx.xxx) And answer ‘yes’ to add the host fingerprint to the ~/.ssh/known_hosts Then try again..   2) login  ssh deploy@xxx.xxx.xxx.xxx   ssh-key generate  1) generate ssh-key  $ ssh-keygen   2) copy the public key  $ cat ~/.ssh/id_rsa.pub   3) paste the key into your github or bitbucket     github            SSH and GPG keys           Bitbucket  	 - YOUR_PROJECT_NAME / Settings / Deployment keys   Setup Capistrano  1) setup Gemfile    - gem &#39;sqlite3&#39;   + gem &#39;sqlite3&#39;, group: :development      - # gem &#39;therubyracer&#39;, platforms: :ruby      + gem &#39;therubyracer&#39;, platforms: :ruby      + group :development do   +   gem &#39;capistrano&#39;,         &#39;~&gt; 3.6.0&#39;, require: false   +   gem &#39;capistrano-rvm&#39;,     &#39;~&gt; 0.1&#39;,   require: false   +   gem &#39;capistrano-rails&#39;,   &#39;~&gt; 1.1.7&#39;, require: false   +   gem &#39;capistrano-bundler&#39;, &#39;~&gt; 1.1.4&#39;, require: false   +   gem &#39;capistrano3-puma&#39;,   &#39;~&gt; 1.2.1&#39;, require: false   + end      + group :production do   +   gem &quot;mysql2&quot;   + end   $ bundle install $ cap install   # =&gt; ask for installing other package? no   2) 	modify Capfile  # Load DSL and set up stages require &quot;capistrano/setup&quot; # Include default deployment tasks require &quot;capistrano/deploy&quot;  require &#39;capistrano/rails&#39; require &#39;capistrano/rvm&#39; require &#39;capistrano/bundler&#39; require &#39;capistrano/rails/assets&#39; require &#39;capistrano/rails/migrations&#39; require &#39;capistrano/puma&#39;  # Load custom tasks from `lib/capistrano/tasks` if you have any defined Dir.glob(&quot;lib/capistrano/tasks/*.rake&quot;).each { |r| import r }   3) replace config/deploy.rb  # config valid only for current version of Capistrano  set :repo_url,        &#39;git@github.com: YOUR_GIT_ACCOUNT/YOUR_PROJECT_NAME&#39; set :application,     &#39;YOUR_PROJECT_NAME&#39; set :user,            &#39;deploy&#39; set :puma_threads,    [4, 16] set :puma_workers,    0  # Don&#39;t change these unless you know what you&#39;re doing set :pty,             true set :use_sudo,        false set :stage,           :production set :deploy_via,      :remote_cache set :deploy_to,       &quot;/home/#{fetch(:user)}/#{fetch(:application)}&quot; set :puma_bind,       &quot;unix://#{shared_path}/tmp/sockets/#{fetch(:application)}-puma.sock&quot; set :puma_state,      &quot;#{shared_path}/tmp/pids/puma.state&quot; set :puma_pid,        &quot;#{shared_path}/tmp/pids/puma.pid&quot; set :puma_access_log, &quot;#{release_path}/log/puma.error.log&quot; set :puma_error_log,  &quot;#{release_path}/log/puma.access.log&quot; set :ssh_options,     { forward_agent: true, user: fetch(:user), keys: %w(~/.ssh/id_rsa.pub) } set :puma_preload_app, true set :puma_worker_timeout, nil set :puma_init_active_record, true  # Change to false when not using ActiveRecord   ## Defaults:  # set :scm,           :git # set :branch,        :master # set :format,        :pretty # set :log_level,     :debug # set :keep_releases, 5  ## Linked Files &amp; Directories (Default None): set :linked_files, %w{config/database.yml config/secrets.yml} set :linked_dirs,  %w{bin log tmp/pids tmp/cache tmp/sockets vendor/bundle public/system}  namespace :puma do   desc &#39;Create Directories for Puma Pids and Socket&#39;   task :make_dirs do     on roles(:app) do       execute &quot;mkdir #{shared_path}/tmp/sockets -p&quot;       execute &quot;mkdir #{shared_path}/tmp/pids -p&quot;     end   end  	before :start, :make_dirs end  namespace :deploy do   desc &quot;Make sure local git is in sync with remote.&quot;   task :check_revision do     on roles(:app) do       unless `git rev-parse HEAD` == `git rev-parse origin/master`         puts &quot;WARNING: HEAD is not the same as origin/master&quot;         puts &quot;Run `git push` to sync changes.&quot;       exit     end   end end  desc &#39;Initial Deploy&#39;   task :initial do   on roles(:app) do     before &#39;deploy:restart&#39;, &#39;puma:start&#39;     invoke &#39;deploy&#39;   end end  desc &#39;Restart application&#39;   task :restart do     on roles(:app), in: :sequence, wait: 5 do     invoke &#39;puma:restart&#39;   end end  desc &#39;Upload to shared/config&#39;   task :upload do   on roles (:app) do     upload! &quot;config/database.yml&quot;, &quot;#{shared_path}/config/database.yml&quot;     upload! &quot;config/secrets.yml&quot;,  &quot;#{shared_path}/config/secrets.yml&quot;   end end  before :starting,  :check_revision after  :finishing, :compile_assets after  :finishing, :cleanup after  :finishing, :restart end  desc &quot;Run rake db:seed on a remote server.&quot; task :seed do   on roles (:app) do     within release_path do       with rails_env: fetch(:rails_env) do       	execute :rake, &quot;db:seed&quot;       end     end   end end  # ps aux | grep puma    # Get puma pid # kill -s SIGUSR2 pid   # Restart puma # kill -s SIGTERM pid   # Stop puma   4) modify config/deploy/production.rb  set :stage, :production set :branch, :master  role :app, %w(deploy@xxx.xxx.xxx.xxx) role :web, %w(deploy@xxx.xxx.xxx.xxx) role :db, %w(deploy@xxx.xxx.xxx.xxx)  set :rails_env, &quot;production&quot; set :puma_env, &quot;production&quot; set :puma_config_file, &quot;#{shared_path}/config/puma.rb&quot; set :puma_conf, &quot;#{shared_path}/config/puma.rb&quot;   5) create config/nignx.conf  	upstream puma-YOUR_PROJECT_NAME { 	  server unix:///home/deploy/YOUR_PROJECT_NAME/shared/tmp/sockets/YOUR_PROJECT_NAME-puma.sock; 	 	} 	 	server { 	  listen 80 default_server deferred; 	  # server_name example.com; 	 	  root /home/deploy/YOUR_PROJECT_NAME/current/public; 	  access_log /home/deploy/YOUR_PROJECT_NAME/current/log/nginx.access.log; 	  error_log /home/deploy/YOUR_PROJECT_NAME/current/log/nginx.error.log info; 	 	  location ^~ /assets/ { 	    gzip_static on; 	    expires max; 	    add_header Cache-Control public; 	  } 	 	  try_files $uri/index.html $uri @puma; 	  location @puma { 	    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; 	    proxy_set_header Host $http_host; 	    proxy_redirect off; 	 	    proxy_pass http://puma-YOUR_PROJECT_NAME; 	 	  } 	 	  error_page 500 502 503 504 /500.html; 	  client_max_body_size 10M; 	  keepalive_timeout 10; 	}   6) modify .gitignore  + /config/database.yml + /config/secrets.yml      copy to *.sample            config/database.yml -&gt; config/database.yml.sample       config/secrets.yml -&gt; config/secrets.yml.sample           delete            config/database.yml       config/secrets.yml           7) first commit  $ git add . $ git commit -m &quot;ready to deploy&quot; $ git push origin master   8) add ymls back and modify  * copy   - config/database.yml.sample -&gt; config/database.yml   - config/secrets.yml.sample -&gt; config/secrets.yml   config/database.yml     production:   -  &lt;&lt;: *default   -  database: db/production.sqlite3   +  adapter: mysql2   +  encoding: utf8mb4   +  database: YOUR_PROJECT_NAME   +  pool: 5   +  username: root   +  password:   +  socket: /var/run/mysqld/mysqld.sock   config/secrets.yml   -  secret_key_base: &lt;%= ENV[&quot;SECRET_KEY_BASE&quot;] %&gt; +  secret_key_base: e4a98dd1063a6765xxxxxxx # copy from development or test secret_key_base   First Deploy  1) check deploy  $ cap production deploy:check   if it shows database.yml does not exist, don&#39;t worry about that. just go next step to copy yml.   2) upload database.yml and secrets.yml from ssh( not git )  $ cap production deploy:upload   3) initial deploy  $ cap production deploy:initial   4) rake db:seed  $ cap production seed      Normal deploy       $ git add . $ git commit -m &quot;commit message&quot; $ git push origin master $ cap production deploy	      Open your website  open your site by ip  http://xxx.xxx.xxx.xxx  if failure, just ssh to Server for log  $ ssh deploy@xxx.xxx.xxx.xxx $ tail -f /home/deploy/YOUR_PROJECT_NAME/current/log/production.log      參考        kakas/CapistranoDeployTest                                             [(Mini Course) Deploy Rails Project to Linux Server             Growth School](http://courses.growthschool.com/courses/deploy-rails-project-to-linux-server)                                                                             [Deploying a Rails App on Ubuntu 14.04 with Capistrano, Nginx, and Puma             DigitalOcean](https://www.digitalocean.com/community/tutorials/deploying-a-rails-app-on-ubuntu-14-04-with-capistrano-nginx-and-puma)">



  <meta property="og:image" content="https://blog.anxgang.com/assets/images/site-logo.png">



  <meta name="twitter:site" content="@anxgang1">
  <meta name="twitter:title" content="[Linode] Deploy Rails app to Linode by Capistrano ( Ubuntu 16.04/nginx/puma/MySQL/rvm )">
  <meta name="twitter:description" content="Ubuntu 16.04 / Ruby 2.3.1 / Rails 5.0.0   Create a Linode    plan:   Ubuntu 16.04 LTS Disk        256MB Swap Image      login user:   root 123456   ssh to remote side and build environment  $ ssh root@xxx.xxx.xxx.xxx #=&gt;  Linode &gt; dashboard &gt; remote access   1) update all packages  $ sudo apt-get -y update;sudo apt-get -y upgrade;sudo apt-get -y autoremove;   2) setup time zone  $ sudo dpkg-reconfigure or  $ sudo timedatectl set-timezone Asia/Taipei   3) Generate locales  $ sudo locale-gen zh_TW zh_TW.UTF-8 zh_CN.UTF-8 en_US.UTF-8;   4) install MySQL  setup root pw: 1234    $ sudo debconf-set-selections &lt;&lt;&lt; &#39;mysql-server mysql-server/root_password password 1234&#39;;sudo debconf-set-selections &lt;&lt;&lt; &#39;mysql-server mysql-server/root_password_again password 1234&#39;;sudo apt-get -y install mysql-server mysql-common mysql-client libmysqlclient-dev;   5) install necessary packages  	$ sudo apt-get install -y build-essential git-core bison openssl libreadline6-dev curl zlib1g zlib1g-dev libssl-dev libyaml-dev libsqlite3-0 libsqlite3-dev sqlite3  autoconf libc6-dev libpcre3-dev curl libcurl4-nss-dev libxml2-dev libxslt-dev imagemagick nodejs libffi-dev   6) install rvm &amp; ruby 2.3.1  $ sudo \curl -sSL https://get.rvm.io | bash;source ~/.rvm/scripts/rvm;rvm install 2.3.1;      if Mac $ sudo \curl -sSL https://get.rvm.io | bash;source /etc/profile.d/rvm.sh;rvm install 2.3.1;   7) install nginx  $ sudo apt-get -y install nginx;   8) install Rails &amp; bundler  $ gem install rails -v &#39;5.0.0&#39; -V --no-ri --no-rdoc;gem install bundler -V --no-ri --no-rdoc;   check your settings  $ date # Wed Aug  6 10:05:17 CST 2016  $ rvm list # =* ruby-2.3.1  $ ruby -v # ruby 2.3.1  $ rails -v # Rails 5.0.0  $ nginx -v # nginx version: nginx/1.4.6 (Ubuntu)  $ mysql -u root -p # enter pw 1234， there will goes `mysql&gt;`， and you can type `exit` to leave   Create database  1) login  $ mysql -u root -p   2) create database  ( replace YOUR_DATABASE_NAME  )  mysql&gt; create database YOUR_DATABASE_NAME default character set utf8mb4;   3) make a check  mysql&gt; show databases;   setup Nginx symlinks (linked to your project)  1) delete default setting  $ sudo rm /etc/nginx/sites-enabled/default   2) add our symlink  ( replace YOUR_PEOJECT_NAME  )  $ sudo ln -nfs &quot;/home/deploy/YOUR_PROJECT_NAME/current/config/nginx.conf&quot; &quot;/etc/nginx/sites-enabled/YOUR_PROJECT_NAME&quot;   3) make a check  $ ls -la /etc/nginx/sites-enabled/ # =&gt;lrwxrwxrwx 1 root root 45 Aug  5 12:06 kixERP -&gt; /home/deploy/YOUR_PROJECT_NAME/current/config/nginx.conf    add a deploy user  1) setup your password (other information you can just enter to pass )  $ adduser deploy   2) Add user deploy to group sudo  $ gpasswd -a deploy sudo   close root login  1) find “PremitRootLogin” , change from yes to no  $ vim /etc/ssh/sshd_config   2) restart ssh service  $ service ssh restart   login by user deploy  1) setup ssh-key login  ssh deploy@xxx.xxx.xxx.xxx &#39;mkdir -p ~/.ssh;cat &gt;&gt; ~/.ssh/authorized_keys&#39; &lt; ~/.ssh/id_rsa.pub      If not work..  Maybe you should login first (ssh deploy@xxx.xxx.xxx.xxx) And answer ‘yes’ to add the host fingerprint to the ~/.ssh/known_hosts Then try again..   2) login  ssh deploy@xxx.xxx.xxx.xxx   ssh-key generate  1) generate ssh-key  $ ssh-keygen   2) copy the public key  $ cat ~/.ssh/id_rsa.pub   3) paste the key into your github or bitbucket     github            SSH and GPG keys           Bitbucket  	 - YOUR_PROJECT_NAME / Settings / Deployment keys   Setup Capistrano  1) setup Gemfile    - gem &#39;sqlite3&#39;   + gem &#39;sqlite3&#39;, group: :development      - # gem &#39;therubyracer&#39;, platforms: :ruby      + gem &#39;therubyracer&#39;, platforms: :ruby      + group :development do   +   gem &#39;capistrano&#39;,         &#39;~&gt; 3.6.0&#39;, require: false   +   gem &#39;capistrano-rvm&#39;,     &#39;~&gt; 0.1&#39;,   require: false   +   gem &#39;capistrano-rails&#39;,   &#39;~&gt; 1.1.7&#39;, require: false   +   gem &#39;capistrano-bundler&#39;, &#39;~&gt; 1.1.4&#39;, require: false   +   gem &#39;capistrano3-puma&#39;,   &#39;~&gt; 1.2.1&#39;, require: false   + end      + group :production do   +   gem &quot;mysql2&quot;   + end   $ bundle install $ cap install   # =&gt; ask for installing other package? no   2) 	modify Capfile  # Load DSL and set up stages require &quot;capistrano/setup&quot; # Include default deployment tasks require &quot;capistrano/deploy&quot;  require &#39;capistrano/rails&#39; require &#39;capistrano/rvm&#39; require &#39;capistrano/bundler&#39; require &#39;capistrano/rails/assets&#39; require &#39;capistrano/rails/migrations&#39; require &#39;capistrano/puma&#39;  # Load custom tasks from `lib/capistrano/tasks` if you have any defined Dir.glob(&quot;lib/capistrano/tasks/*.rake&quot;).each { |r| import r }   3) replace config/deploy.rb  # config valid only for current version of Capistrano  set :repo_url,        &#39;git@github.com: YOUR_GIT_ACCOUNT/YOUR_PROJECT_NAME&#39; set :application,     &#39;YOUR_PROJECT_NAME&#39; set :user,            &#39;deploy&#39; set :puma_threads,    [4, 16] set :puma_workers,    0  # Don&#39;t change these unless you know what you&#39;re doing set :pty,             true set :use_sudo,        false set :stage,           :production set :deploy_via,      :remote_cache set :deploy_to,       &quot;/home/#{fetch(:user)}/#{fetch(:application)}&quot; set :puma_bind,       &quot;unix://#{shared_path}/tmp/sockets/#{fetch(:application)}-puma.sock&quot; set :puma_state,      &quot;#{shared_path}/tmp/pids/puma.state&quot; set :puma_pid,        &quot;#{shared_path}/tmp/pids/puma.pid&quot; set :puma_access_log, &quot;#{release_path}/log/puma.error.log&quot; set :puma_error_log,  &quot;#{release_path}/log/puma.access.log&quot; set :ssh_options,     { forward_agent: true, user: fetch(:user), keys: %w(~/.ssh/id_rsa.pub) } set :puma_preload_app, true set :puma_worker_timeout, nil set :puma_init_active_record, true  # Change to false when not using ActiveRecord   ## Defaults:  # set :scm,           :git # set :branch,        :master # set :format,        :pretty # set :log_level,     :debug # set :keep_releases, 5  ## Linked Files &amp; Directories (Default None): set :linked_files, %w{config/database.yml config/secrets.yml} set :linked_dirs,  %w{bin log tmp/pids tmp/cache tmp/sockets vendor/bundle public/system}  namespace :puma do   desc &#39;Create Directories for Puma Pids and Socket&#39;   task :make_dirs do     on roles(:app) do       execute &quot;mkdir #{shared_path}/tmp/sockets -p&quot;       execute &quot;mkdir #{shared_path}/tmp/pids -p&quot;     end   end  	before :start, :make_dirs end  namespace :deploy do   desc &quot;Make sure local git is in sync with remote.&quot;   task :check_revision do     on roles(:app) do       unless `git rev-parse HEAD` == `git rev-parse origin/master`         puts &quot;WARNING: HEAD is not the same as origin/master&quot;         puts &quot;Run `git push` to sync changes.&quot;       exit     end   end end  desc &#39;Initial Deploy&#39;   task :initial do   on roles(:app) do     before &#39;deploy:restart&#39;, &#39;puma:start&#39;     invoke &#39;deploy&#39;   end end  desc &#39;Restart application&#39;   task :restart do     on roles(:app), in: :sequence, wait: 5 do     invoke &#39;puma:restart&#39;   end end  desc &#39;Upload to shared/config&#39;   task :upload do   on roles (:app) do     upload! &quot;config/database.yml&quot;, &quot;#{shared_path}/config/database.yml&quot;     upload! &quot;config/secrets.yml&quot;,  &quot;#{shared_path}/config/secrets.yml&quot;   end end  before :starting,  :check_revision after  :finishing, :compile_assets after  :finishing, :cleanup after  :finishing, :restart end  desc &quot;Run rake db:seed on a remote server.&quot; task :seed do   on roles (:app) do     within release_path do       with rails_env: fetch(:rails_env) do       	execute :rake, &quot;db:seed&quot;       end     end   end end  # ps aux | grep puma    # Get puma pid # kill -s SIGUSR2 pid   # Restart puma # kill -s SIGTERM pid   # Stop puma   4) modify config/deploy/production.rb  set :stage, :production set :branch, :master  role :app, %w(deploy@xxx.xxx.xxx.xxx) role :web, %w(deploy@xxx.xxx.xxx.xxx) role :db, %w(deploy@xxx.xxx.xxx.xxx)  set :rails_env, &quot;production&quot; set :puma_env, &quot;production&quot; set :puma_config_file, &quot;#{shared_path}/config/puma.rb&quot; set :puma_conf, &quot;#{shared_path}/config/puma.rb&quot;   5) create config/nignx.conf  	upstream puma-YOUR_PROJECT_NAME { 	  server unix:///home/deploy/YOUR_PROJECT_NAME/shared/tmp/sockets/YOUR_PROJECT_NAME-puma.sock; 	 	} 	 	server { 	  listen 80 default_server deferred; 	  # server_name example.com; 	 	  root /home/deploy/YOUR_PROJECT_NAME/current/public; 	  access_log /home/deploy/YOUR_PROJECT_NAME/current/log/nginx.access.log; 	  error_log /home/deploy/YOUR_PROJECT_NAME/current/log/nginx.error.log info; 	 	  location ^~ /assets/ { 	    gzip_static on; 	    expires max; 	    add_header Cache-Control public; 	  } 	 	  try_files $uri/index.html $uri @puma; 	  location @puma { 	    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; 	    proxy_set_header Host $http_host; 	    proxy_redirect off; 	 	    proxy_pass http://puma-YOUR_PROJECT_NAME; 	 	  } 	 	  error_page 500 502 503 504 /500.html; 	  client_max_body_size 10M; 	  keepalive_timeout 10; 	}   6) modify .gitignore  + /config/database.yml + /config/secrets.yml      copy to *.sample            config/database.yml -&gt; config/database.yml.sample       config/secrets.yml -&gt; config/secrets.yml.sample           delete            config/database.yml       config/secrets.yml           7) first commit  $ git add . $ git commit -m &quot;ready to deploy&quot; $ git push origin master   8) add ymls back and modify  * copy   - config/database.yml.sample -&gt; config/database.yml   - config/secrets.yml.sample -&gt; config/secrets.yml   config/database.yml     production:   -  &lt;&lt;: *default   -  database: db/production.sqlite3   +  adapter: mysql2   +  encoding: utf8mb4   +  database: YOUR_PROJECT_NAME   +  pool: 5   +  username: root   +  password:   +  socket: /var/run/mysqld/mysqld.sock   config/secrets.yml   -  secret_key_base: &lt;%= ENV[&quot;SECRET_KEY_BASE&quot;] %&gt; +  secret_key_base: e4a98dd1063a6765xxxxxxx # copy from development or test secret_key_base   First Deploy  1) check deploy  $ cap production deploy:check   if it shows database.yml does not exist, don&#39;t worry about that. just go next step to copy yml.   2) upload database.yml and secrets.yml from ssh( not git )  $ cap production deploy:upload   3) initial deploy  $ cap production deploy:initial   4) rake db:seed  $ cap production seed      Normal deploy       $ git add . $ git commit -m &quot;commit message&quot; $ git push origin master $ cap production deploy	      Open your website  open your site by ip  http://xxx.xxx.xxx.xxx  if failure, just ssh to Server for log  $ ssh deploy@xxx.xxx.xxx.xxx $ tail -f /home/deploy/YOUR_PROJECT_NAME/current/log/production.log      參考        kakas/CapistranoDeployTest                                             [(Mini Course) Deploy Rails Project to Linux Server             Growth School](http://courses.growthschool.com/courses/deploy-rails-project-to-linux-server)                                                                             [Deploying a Rails App on Ubuntu 14.04 with Capistrano, Nginx, and Puma             DigitalOcean](https://www.digitalocean.com/community/tutorials/deploying-a-rails-app-on-ubuntu-14-04-with-capistrano-nginx-and-puma)">
  <meta name="twitter:url" content="https://blog.anxgang.com/linode-deploy-to-linode-by-capistrano-ubuntu-1604-nginx-puma-mysql-rvm/">

  
    <meta name="twitter:card" content="summary">
    
      <meta name="twitter:image" content="https://blog.anxgang.com/assets/images/site-logo.png">
    
  

  



  <meta property="article:published_time" content="2016-08-08T03:07:00+08:00">





  

  


<link rel="canonical" href="https://blog.anxgang.com/linode-deploy-to-linode-by-capistrano-ubuntu-1604-nginx-puma-mysql-rvm/">




<script type="application/ld+json">
  {
    "@context": "https://schema.org",
    
      "@type": "Person",
      "name": "anxgang",
      "url": "https://blog.anxgang.com/"
    
  }
</script>







<!-- end _includes/seo.html -->



  <link href="/feed.xml" type="application/atom+xml" rel="alternate" title="ANxGANG Feed">


<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
<noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css"></noscript>



    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->
<link rel="apple-touch-icon" sizes="180x180" href="/assets/icons/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/assets/icons/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/assets/icons/favicon-16x16.png">
<link rel="manifest" href="/assets/icons/site.webmanifest">
<link rel="mask-icon" href="/assets/icons/safari-pinned-tab.svg" color="#5bbad5">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="theme-color" content="#ffffff">
<!-- end custom head snippets -->
  </head>

  <body class="layout--post">
    <nav class="skip-links">
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">轉至主導航欄</a></li>
    <li><a href="#main" class="screen-reader-shortcut">轉至内容</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">轉至頁脚</a></li>
  </ul>
</nav>

    

<div class="masthead sticky">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
        <a class="site-title" href="/">
          ANxGANG
          <span class="site-subtitle"></span>
        </a>
        <ul class="visible-links">
            
            
              <li class="dropdown ">
                <a  class="dropdown-toggle"
                  data-toggle="dropdown" role="button"
                  aria-haspopup="true"
                  aria-expanded="false">Docs <i class="fa fa-caret-down fa-sm" aria-hidden="true"></i>
                  <span class="caret"></span>
                </a>
                <ul class="dropdown-content">
                  
                  <li>
                    <a href="/docs/rails-compact-guide/01-getting-started"> Rails Compact Guide</a>
                  </li>
                  
                </ul>
              </li>
            
          
            
            
              <li class="dropdown ">
                <a href="/year-archive/"  class="dropdown-toggle"
                  data-toggle="dropdown" role="button"
                  aria-haspopup="true"
                  aria-expanded="false">Archive <i class="fa fa-caret-down fa-sm" aria-hidden="true"></i>
                  <span class="caret"></span>
                </a>
                <ul class="dropdown-content">
                  
                  <li>
                    <a href="/categories/"> By Category</a>
                  </li>
                  
                  <li>
                    <a href="/tags/"> By Tag</a>
                  </li>
                  
                  <li>
                    <a href="/year-archive/"> By Year</a>
                  </li>
                  
                  <li>
                    <a href="/month-archive/"> By Month</a>
                  </li>
                  
                </ul>
              </li>
            
          
            
            
              <li class="masthead__menu-item">
                <a href="/tool-sites/">Tools</a>
              </li>
            
          
            
            
              <li class="masthead__menu-item">
                <a href="/about/">About</a>
              </li>
            
          
        </ul>
        
        <button class="search__toggle" type="button">
          <span
            class="visually-hidden">切換搜尋</span>
          <svg class="icon" width="16" height="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 15.99 16">
            <path
              d="M15.5,13.12L13.19,10.8a1.69,1.69,0,0,0-1.28-.55l-0.06-.06A6.5,6.5,0,0,0,5.77,0,6.5,6.5,0,0,0,2.46,11.59a6.47,6.47,0,0,0,7.74.26l0.05,0.05a1.65,1.65,0,0,0,.5,1.24l2.38,2.38A1.68,1.68,0,0,0,15.5,13.12ZM6.4,2A4.41,4.41,0,1,1,2,6.4,4.43,4.43,0,0,1,6.4,2Z"
              transform="translate(-.01)"></path>
          </svg>
        </button>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">選單</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>

    <div class="initial-content">
      





<div id="main" role="main">
    
  <div class="sidebar sticky">
  


<div itemscope itemtype="https://schema.org/Person" class="h-card">

  
    <div class="author__avatar">
      <a href="https://blog.anxgang.com/">
        <img src="/assets/images/bio-photo-5.png" alt="anxgang" itemprop="image" class="u-photo">
      </a>
    </div>
  

  <div class="author__content">
    <h3 class="author__name p-name" itemprop="name">
      <a class="u-url" rel="me" href="https://blog.anxgang.com/" itemprop="url">anxgang</a>
    </h3>
    
      <div class="author__bio p-note" itemprop="description">
        <p>Just a copy paste developer.</p>

      </div>
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">追蹤</button>
    <ul class="author__urls social-icons">
      
        <li itemprop="homeLocation" itemscope itemtype="https://schema.org/Place">
          <i class="fas fa-fw fa-map-marker-alt" aria-hidden="true"></i> <span itemprop="name" class="p-locality">Kaohsiung, Taiwan</span>
        </li>
      

      
        
          
            <li><a href="https://twitter.com/anxgang1" rel="nofollow noopener noreferrer me" itemprop="sameAs"><i class="fab fa-fw fa-twitter-square" aria-hidden="true"></i><span class="label">Twitter</span></a></li>
          
        
          
            <li><a href="https://github.com/anxgang" rel="nofollow noopener noreferrer me" itemprop="sameAs"><i class="fab fa-fw fa-github" aria-hidden="true"></i><span class="label">GitHub</span></a></li>
          
        
      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      <!--
  <li>
    <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs" rel="nofollow noopener noreferrer me">
      <i class="fas fa-fw" aria-hidden="true"></i> Custom Social Profile Link
    </a>
  </li>
-->
    </ul>
  </div>
</div>

  
  </div>



    <article class="page h-entry" itemscope itemtype="https://schema.org/CreativeWork">
        
        <meta itemprop="headline" content="[Linode] Deploy Rails app to Linode by Capistrano ( Ubuntu 16.04/nginx/puma/MySQL/rvm )">
        
        
        <meta itemprop="description"
            content="  Ubuntu 16.04 / Ruby 2.3.1 / Rails 5.0.0Create a Linode  plan:  Ubuntu 16.04 LTS Disk      256MB Swap Image    login user:  root 123456ssh to remote side and build environment$ ssh root@xxx.xxx.xxx.xxx#=&gt;  Linode &gt; dashboard &gt; remote access1) update all packages$ sudo apt-get -y update;sudo apt-get -y upgrade;sudo apt-get -y autoremove;2) setup time zone$ sudo dpkg-reconfigureor $ sudo timedatectl set-timezone Asia/Taipei3) Generate locales$ sudo locale-gen zh_TW zh_TW.UTF-8 zh_CN.UTF-8 en_US.UTF-8;4) install MySQLsetup root pw: 1234  $ sudo debconf-set-selections &lt;&lt;&lt; &#39;mysql-server mysql-server/root_password password 1234&#39;;sudo debconf-set-selections &lt;&lt;&lt; &#39;mysql-server mysql-server/root_password_again password 1234&#39;;sudo apt-get -y install mysql-server mysql-common mysql-client libmysqlclient-dev;5) install necessary packages	$ sudo apt-get install -y build-essential git-core bison openssl libreadline6-dev curl zlib1g zlib1g-dev libssl-dev libyaml-dev libsqlite3-0 libsqlite3-dev sqlite3  autoconf libc6-dev libpcre3-dev curl libcurl4-nss-dev libxml2-dev libxslt-dev imagemagick nodejs libffi-dev6) install rvm &amp; ruby 2.3.1$ sudo \curl -sSL https://get.rvm.io | bash;source ~/.rvm/scripts/rvm;rvm install 2.3.1;  if Mac$ sudo \curl -sSL https://get.rvm.io | bash;source /etc/profile.d/rvm.sh;rvm install 2.3.1;7) install nginx$ sudo apt-get -y install nginx;8) install Rails &amp; bundler$ gem install rails -v &#39;5.0.0&#39; -V --no-ri --no-rdoc;gem install bundler -V --no-ri --no-rdoc;check your settings$ date# Wed Aug  6 10:05:17 CST 2016$ rvm list# =* ruby-2.3.1$ ruby -v# ruby 2.3.1$ rails -v# Rails 5.0.0$ nginx -v# nginx version: nginx/1.4.6 (Ubuntu)$ mysql -u root -p# enter pw 1234， there will goes `mysql&gt;`， and you can type `exit` to leave Create database1) login$ mysql -u root -p2) create database  ( replace YOUR_DATABASE_NAME  )mysql&gt; create database YOUR_DATABASE_NAME default character set utf8mb4;3) make a checkmysql&gt; show databases;setup Nginx symlinks (linked to your project)1) delete default setting$ sudo rm /etc/nginx/sites-enabled/default2) add our symlink  ( replace YOUR_PEOJECT_NAME  )$ sudo ln -nfs &quot;/home/deploy/YOUR_PROJECT_NAME/current/config/nginx.conf&quot; &quot;/etc/nginx/sites-enabled/YOUR_PROJECT_NAME&quot;3) make a check$ ls -la /etc/nginx/sites-enabled/# =&gt;lrwxrwxrwx 1 root root 45 Aug  5 12:06 kixERP -&gt; /home/deploy/YOUR_PROJECT_NAME/current/config/nginx.conf add a deploy user1) setup your password (other information you can just enter to pass )$ adduser deploy2) Add user deploy to group sudo$ gpasswd -a deploy sudoclose root login1) find “PremitRootLogin” , change from yes to no$ vim /etc/ssh/sshd_config2) restart ssh service$ service ssh restartlogin by user deploy1) setup ssh-key loginssh deploy@xxx.xxx.xxx.xxx &#39;mkdir -p ~/.ssh;cat &gt;&gt; ~/.ssh/authorized_keys&#39; &lt; ~/.ssh/id_rsa.pub  If not work.. Maybe you should login first (ssh deploy@xxx.xxx.xxx.xxx)And answer ‘yes’ to add the host fingerprint to the ~/.ssh/known_hostsThen try again..2) loginssh deploy@xxx.xxx.xxx.xxxssh-key generate1) generate ssh-key$ ssh-keygen2) copy the public key$ cat ~/.ssh/id_rsa.pub3) paste the key into your github or bitbucket  github          SSH and GPG keys        Bitbucket 	 - YOUR_PROJECT_NAME / Settings / Deployment keysSetup Capistrano1) setup Gemfile  - gem &#39;sqlite3&#39;  + gem &#39;sqlite3&#39;, group: :development    - # gem &#39;therubyracer&#39;, platforms: :ruby    + gem &#39;therubyracer&#39;, platforms: :ruby    + group :development do  +   gem &#39;capistrano&#39;,         &#39;~&gt; 3.6.0&#39;, require: false  +   gem &#39;capistrano-rvm&#39;,     &#39;~&gt; 0.1&#39;,   require: false  +   gem &#39;capistrano-rails&#39;,   &#39;~&gt; 1.1.7&#39;, require: false  +   gem &#39;capistrano-bundler&#39;, &#39;~&gt; 1.1.4&#39;, require: false  +   gem &#39;capistrano3-puma&#39;,   &#39;~&gt; 1.2.1&#39;, require: false  + end    + group :production do  +   gem &quot;mysql2&quot;  + end$ bundle install$ cap install  # =&gt; ask for installing other package? no2) 	modify Capfile# Load DSL and set up stagesrequire &quot;capistrano/setup&quot;# Include default deployment tasksrequire &quot;capistrano/deploy&quot;require &#39;capistrano/rails&#39;require &#39;capistrano/rvm&#39;require &#39;capistrano/bundler&#39;require &#39;capistrano/rails/assets&#39;require &#39;capistrano/rails/migrations&#39;require &#39;capistrano/puma&#39;# Load custom tasks from `lib/capistrano/tasks` if you have any definedDir.glob(&quot;lib/capistrano/tasks/*.rake&quot;).each { |r| import r }3) replace config/deploy.rb# config valid only for current version of Capistranoset :repo_url,        &#39;git@github.com: YOUR_GIT_ACCOUNT/YOUR_PROJECT_NAME&#39;set :application,     &#39;YOUR_PROJECT_NAME&#39;set :user,            &#39;deploy&#39;set :puma_threads,    [4, 16]set :puma_workers,    0# Don&#39;t change these unless you know what you&#39;re doingset :pty,             trueset :use_sudo,        falseset :stage,           :productionset :deploy_via,      :remote_cacheset :deploy_to,       &quot;/home/#{fetch(:user)}/#{fetch(:application)}&quot;set :puma_bind,       &quot;unix://#{shared_path}/tmp/sockets/#{fetch(:application)}-puma.sock&quot;set :puma_state,      &quot;#{shared_path}/tmp/pids/puma.state&quot;set :puma_pid,        &quot;#{shared_path}/tmp/pids/puma.pid&quot;set :puma_access_log, &quot;#{release_path}/log/puma.error.log&quot;set :puma_error_log,  &quot;#{release_path}/log/puma.access.log&quot;set :ssh_options,     { forward_agent: true, user: fetch(:user), keys: %w(~/.ssh/id_rsa.pub) }set :puma_preload_app, trueset :puma_worker_timeout, nilset :puma_init_active_record, true  # Change to false when not using ActiveRecord## Defaults:# set :scm,           :git# set :branch,        :master# set :format,        :pretty# set :log_level,     :debug# set :keep_releases, 5## Linked Files &amp; Directories (Default None):set :linked_files, %w{config/database.yml config/secrets.yml}set :linked_dirs,  %w{bin log tmp/pids tmp/cache tmp/sockets vendor/bundle public/system}namespace :puma do  desc &#39;Create Directories for Puma Pids and Socket&#39;  task :make_dirs do    on roles(:app) do      execute &quot;mkdir #{shared_path}/tmp/sockets -p&quot;      execute &quot;mkdir #{shared_path}/tmp/pids -p&quot;    end  end	before :start, :make_dirsendnamespace :deploy do  desc &quot;Make sure local git is in sync with remote.&quot;  task :check_revision do    on roles(:app) do      unless `git rev-parse HEAD` == `git rev-parse origin/master`        puts &quot;WARNING: HEAD is not the same as origin/master&quot;        puts &quot;Run `git push` to sync changes.&quot;      exit    end  endenddesc &#39;Initial Deploy&#39;  task :initial do  on roles(:app) do    before &#39;deploy:restart&#39;, &#39;puma:start&#39;    invoke &#39;deploy&#39;  endenddesc &#39;Restart application&#39;  task :restart do    on roles(:app), in: :sequence, wait: 5 do    invoke &#39;puma:restart&#39;  endenddesc &#39;Upload to shared/config&#39;  task :upload do  on roles (:app) do    upload! &quot;config/database.yml&quot;, &quot;#{shared_path}/config/database.yml&quot;    upload! &quot;config/secrets.yml&quot;,  &quot;#{shared_path}/config/secrets.yml&quot;  endendbefore :starting,  :check_revisionafter  :finishing, :compile_assetsafter  :finishing, :cleanupafter  :finishing, :restartenddesc &quot;Run rake db:seed on a remote server.&quot;task :seed do  on roles (:app) do    within release_path do      with rails_env: fetch(:rails_env) do      	execute :rake, &quot;db:seed&quot;      end    end  endend# ps aux | grep puma    # Get puma pid# kill -s SIGUSR2 pid   # Restart puma# kill -s SIGTERM pid   # Stop puma4) modify config/deploy/production.rbset :stage, :productionset :branch, :masterrole :app, %w(deploy@xxx.xxx.xxx.xxx)role :web, %w(deploy@xxx.xxx.xxx.xxx)role :db, %w(deploy@xxx.xxx.xxx.xxx)set :rails_env, &quot;production&quot;set :puma_env, &quot;production&quot;set :puma_config_file, &quot;#{shared_path}/config/puma.rb&quot;set :puma_conf, &quot;#{shared_path}/config/puma.rb&quot;5) create config/nignx.conf	upstream puma-YOUR_PROJECT_NAME {	  server unix:///home/deploy/YOUR_PROJECT_NAME/shared/tmp/sockets/YOUR_PROJECT_NAME-puma.sock;		}		server {	  listen 80 default_server deferred;	  # server_name example.com;		  root /home/deploy/YOUR_PROJECT_NAME/current/public;	  access_log /home/deploy/YOUR_PROJECT_NAME/current/log/nginx.access.log;	  error_log /home/deploy/YOUR_PROJECT_NAME/current/log/nginx.error.log info;		  location ^~ /assets/ {	    gzip_static on;	    expires max;	    add_header Cache-Control public;	  }		  try_files $uri/index.html $uri @puma;	  location @puma {	    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;	    proxy_set_header Host $http_host;	    proxy_redirect off;		    proxy_pass http://puma-YOUR_PROJECT_NAME;		  }		  error_page 500 502 503 504 /500.html;	  client_max_body_size 10M;	  keepalive_timeout 10;	}6) modify .gitignore+ /config/database.yml+ /config/secrets.yml  copy to *.sample          config/database.yml -&gt; config/database.yml.sample      config/secrets.yml -&gt; config/secrets.yml.sample        delete          config/database.yml      config/secrets.yml      7) first commit$ git add .$ git commit -m &quot;ready to deploy&quot;$ git push origin master8) add ymls back and modify* copy  - config/database.yml.sample -&gt; config/database.yml  - config/secrets.yml.sample -&gt; config/secrets.ymlconfig/database.yml  production:  -  &lt;&lt;: *default  -  database: db/production.sqlite3  +  adapter: mysql2  +  encoding: utf8mb4  +  database: YOUR_PROJECT_NAME  +  pool: 5  +  username: root  +  password:  +  socket: /var/run/mysqld/mysqld.sockconfig/secrets.yml-  secret_key_base: &lt;%= ENV[&quot;SECRET_KEY_BASE&quot;] %&gt;+  secret_key_base: e4a98dd1063a6765xxxxxxx # copy from development or test secret_key_baseFirst Deploy1) check deploy$ cap production deploy:checkif it shows database.yml does not exist, don&#39;t worry about that. just go next step to copy yml.2) upload database.yml and secrets.yml from ssh( not git )$ cap production deploy:upload3) initial deploy$ cap production deploy:initial4) rake db:seed$ cap production seed  Normal deploy  $ git add .$ git commit -m &quot;commit message&quot;$ git push origin master$ cap production deploy	  Open your websiteopen your site by iphttp://xxx.xxx.xxx.xxxif failure, just ssh to Server for log$ ssh deploy@xxx.xxx.xxx.xxx$ tail -f /home/deploy/YOUR_PROJECT_NAME/current/log/production.log  參考      kakas/CapistranoDeployTest                                        [(Mini Course) Deploy Rails Project to Linux Server            Growth School](http://courses.growthschool.com/courses/deploy-rails-project-to-linux-server)                                                                    [Deploying a Rails App on Ubuntu 14.04 with Capistrano, Nginx, and Puma            DigitalOcean](https://www.digitalocean.com/community/tutorials/deploying-a-rails-app-on-ubuntu-14-04-with-capistrano-nginx-and-puma)                              ">
        
        <meta itemprop="datePublished" content="2016-08-08T03:07:00+08:00">
        

        <div class="page__inner-wrap">
            
            <header>
                <h1 id="page-title" class="page__title p-name" itemprop="headline">
                    <a href="https://blog.anxgang.com/linode-deploy-to-linode-by-capistrano-ubuntu-1604-nginx-puma-mysql-rvm/" class="u-url"
                        itemprop="url">[Linode] Deploy Rails app to Linode by Capistrano ( Ubuntu 16.04/nginx/puma/MySQL/rvm )
</a>
                </h1>
                

  <p class="page__meta">
    
      
      <span class="page__meta-date">
        <i class="far fa-calendar-alt" aria-hidden="true"></i>
        
         
        <time datetime="2016-08-08T03:07:00+08:00">2016-08-08</time>
      </span>
    

    <span class="page__meta-sep"></span>

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-clock" aria-hidden="true"></i>
        
          6 分鐘閱讀
        
      </span>
    
  </p>


            </header>
            

            <section class="page__content e-content" itemprop="text">
                
                <aside class="sidebar__right sticky">
                    <nav class="toc">
                        <header>
                            <h4 class="nav__title"><i class="fas fa-indent"></i><!--'file-alt'-->
                                &nbsp;索引
                            </h4>
                        </header>
                        <ul class="toc__menu"><li><a href="#create-a-linode">Create a Linode</a></li><li><a href="#ssh-to-remote-side-and-build-environment">ssh to remote side and build environment</a></li><li><a href="#check-your-settings">check your settings</a></li><li><a href="#create-database">Create database</a></li><li><a href="#setup-nginx-symlinks-linked-to-your-project">setup Nginx symlinks (linked to your project)</a></li><li><a href="#add-a-deploy-user">add a deploy user</a></li><li><a href="#close-root-login">close root login</a></li><li><a href="#login-by-user-deploy">login by user deploy</a></li><li><a href="#ssh-key-generate">ssh-key generate</a></li><li><a href="#setup-capistrano">Setup Capistrano</a></li><li><a href="#first-deploy">First Deploy</a></li><li><a href="#open-your-website">Open your website</a></li></ul>

                    </nav>
                </aside>
                
                <blockquote>
  <p>Ubuntu 16.04 / Ruby 2.3.1 / Rails 5.0.0</p>
</blockquote>

<h2 id="create-a-linode">Create a Linode</h2>
<ul>
  <li>plan:</li>
  <li>Ubuntu 16.04 LTS Disk</li>
  <li>
    <p>256MB Swap Image</p>
  </li>
  <li>login user:</li>
  <li>root 123456</li>
</ul>

<h2 id="ssh-to-remote-side-and-build-environment">ssh to remote side and build environment</h2>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>ssh root@xxx.xxx.xxx.xxx
<span class="c">#=&gt;  Linode &gt; dashboard &gt; remote access</span>
</code></pre></div></div>

<p>1) update all packages</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo </span>apt-get <span class="nt">-y</span> update<span class="p">;</span><span class="nb">sudo </span>apt-get <span class="nt">-y</span> upgrade<span class="p">;</span><span class="nb">sudo </span>apt-get <span class="nt">-y</span> autoremove<span class="p">;</span>
</code></pre></div></div>

<p>2) setup time zone</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo </span>dpkg-reconfigure
or 
<span class="nv">$ </span><span class="nb">sudo </span>timedatectl set-timezone Asia/Taipei
</code></pre></div></div>

<p>3) Generate locales</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo </span>locale-gen zh_TW zh_TW.UTF-8 zh_CN.UTF-8 en_US.UTF-8<span class="p">;</span>
</code></pre></div></div>

<p>4) install MySQL</p>

<p>setup root pw: 1234</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="nv">$ </span><span class="nb">sudo </span>debconf-set-selections <span class="o">&lt;&lt;&lt;</span> <span class="s1">'mysql-server mysql-server/root_password password 1234'</span><span class="p">;</span><span class="nb">sudo </span>debconf-set-selections <span class="o">&lt;&lt;&lt;</span> <span class="s1">'mysql-server mysql-server/root_password_again password 1234'</span><span class="p">;</span><span class="nb">sudo </span>apt-get <span class="nt">-y</span> <span class="nb">install </span>mysql-server mysql-common mysql-client libmysqlclient-dev<span class="p">;</span>
</code></pre></div></div>

<p>5) install necessary packages</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	<span class="nv">$ </span><span class="nb">sudo </span>apt-get <span class="nb">install</span> <span class="nt">-y</span> build-essential git-core bison openssl libreadline6-dev curl zlib1g zlib1g-dev libssl-dev libyaml-dev libsqlite3-0 libsqlite3-dev sqlite3  autoconf libc6-dev libpcre3-dev curl libcurl4-nss-dev libxml2-dev libxslt-dev imagemagick nodejs libffi-dev
</code></pre></div></div>

<p>6) install rvm &amp; ruby 2.3.1</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo</span> <span class="se">\c</span>url <span class="nt">-sSL</span> https://get.rvm.io | bash<span class="p">;</span><span class="nb">source</span> ~/.rvm/scripts/rvm<span class="p">;</span>rvm <span class="nb">install </span>2.3.1<span class="p">;</span>
</code></pre></div></div>

<blockquote>
  <p>if Mac
$ sudo \curl -sSL https://get.rvm.io | bash;source /etc/profile.d/rvm.sh;rvm install 2.3.1;</p>
</blockquote>

<p>7) install nginx</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo </span>apt-get <span class="nt">-y</span> <span class="nb">install </span>nginx<span class="p">;</span>
</code></pre></div></div>

<p>8) install Rails &amp; bundler</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>gem <span class="nb">install </span>rails <span class="nt">-v</span> <span class="s1">'5.0.0'</span> <span class="nt">-V</span> <span class="nt">--no-ri</span> <span class="nt">--no-rdoc</span><span class="p">;</span>gem <span class="nb">install </span>bundler <span class="nt">-V</span> <span class="nt">--no-ri</span> <span class="nt">--no-rdoc</span><span class="p">;</span>
</code></pre></div></div>

<h2 id="check-your-settings">check your settings</h2>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">date</span>
<span class="c"># Wed Aug  6 10:05:17 CST 2016</span>

<span class="nv">$ </span>rvm list
<span class="c"># =* ruby-2.3.1</span>

<span class="nv">$ </span>ruby <span class="nt">-v</span>
<span class="c"># ruby 2.3.1</span>

<span class="nv">$ </span>rails <span class="nt">-v</span>
<span class="c"># Rails 5.0.0</span>

<span class="nv">$ </span>nginx <span class="nt">-v</span>
<span class="c"># nginx version: nginx/1.4.6 (Ubuntu)</span>

<span class="nv">$ </span>mysql <span class="nt">-u</span> root <span class="nt">-p</span>
<span class="c"># enter pw 1234， there will goes `mysql&gt;`， and you can type `exit` to leave </span>
</code></pre></div></div>
<h2 id="create-database">Create database</h2>

<p>1) login</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>mysql <span class="nt">-u</span> root <span class="nt">-p</span>
</code></pre></div></div>

<p>2) create database  ( replace YOUR_DATABASE_NAME  )</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mysql&gt; create database YOUR_DATABASE_NAME default character <span class="nb">set </span>utf8mb4<span class="p">;</span>
</code></pre></div></div>

<p>3) make a check</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mysql&gt; show databases<span class="p">;</span>
</code></pre></div></div>

<h2 id="setup-nginx-symlinks-linked-to-your-project">setup Nginx symlinks (linked to your project)</h2>

<p>1) delete default setting</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo rm</span> /etc/nginx/sites-enabled/default
</code></pre></div></div>

<p>2) add our symlink  ( replace YOUR_PEOJECT_NAME  )</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo ln</span> <span class="nt">-nfs</span> <span class="s2">"/home/deploy/YOUR_PROJECT_NAME/current/config/nginx.conf"</span> <span class="s2">"/etc/nginx/sites-enabled/YOUR_PROJECT_NAME"</span>
</code></pre></div></div>

<p>3) make a check</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-la</span> /etc/nginx/sites-enabled/
<span class="c"># =&gt;lrwxrwxrwx 1 root root 45 Aug  5 12:06 kixERP -&gt; /home/deploy/YOUR_PROJECT_NAME/current/config/nginx.conf </span>
</code></pre></div></div>

<h2 id="add-a-deploy-user">add a deploy user</h2>

<p>1) setup your password (other information you can just enter to pass )</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>adduser deploy
</code></pre></div></div>

<p>2) Add user deploy to group sudo</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>gpasswd <span class="nt">-a</span> deploy <span class="nb">sudo</span>
</code></pre></div></div>

<h2 id="close-root-login">close root login</h2>

<p>1) find “PremitRootLogin” , change from yes to no</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>vim /etc/ssh/sshd_config
</code></pre></div></div>

<p>2) restart ssh service</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>service ssh restart
</code></pre></div></div>

<h2 id="login-by-user-deploy">login by user deploy</h2>

<p>1) setup ssh-key login</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ssh deploy@xxx.xxx.xxx.xxx <span class="s1">'mkdir -p ~/.ssh;cat &gt;&gt; ~/.ssh/authorized_keys'</span> &lt; ~/.ssh/id_rsa.pub
</code></pre></div></div>

<blockquote>
  <p>If not work.. 
Maybe you should login first (<code class="language-plaintext highlighter-rouge">ssh deploy@xxx.xxx.xxx.xxx</code>)
And answer ‘yes’ to add the host fingerprint to the <code class="language-plaintext highlighter-rouge">~/.ssh/known_hosts</code>
Then try again..</p>
</blockquote>

<p>2) login</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ssh deploy@xxx.xxx.xxx.xxx
</code></pre></div></div>

<h2 id="ssh-key-generate">ssh-key generate</h2>

<p>1) generate ssh-key</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>ssh-keygen
</code></pre></div></div>

<p>2) copy the public key</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">cat</span> ~/.ssh/id_rsa.pub
</code></pre></div></div>

<p>3) paste the key into your github or bitbucket</p>

<ul>
  <li>github
    <ul>
      <li><a href="https://github.com/settings/keys">SSH and GPG keys</a></li>
    </ul>
  </li>
  <li>Bitbucket
 	 - YOUR_PROJECT_NAME / Settings / Deployment keys</li>
</ul>

<h2 id="setup-capistrano">Setup Capistrano</h2>

<p>1) setup Gemfile</p>

<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="o">-</span> <span class="n">gem</span> <span class="s1">'sqlite3'</span>
  <span class="o">+</span> <span class="n">gem</span> <span class="s1">'sqlite3'</span><span class="p">,</span> <span class="ss">group: :development</span>
  
  <span class="o">-</span> <span class="c1"># gem 'therubyracer', platforms: :ruby</span>
  
  <span class="o">+</span> <span class="n">gem</span> <span class="s1">'therubyracer'</span><span class="p">,</span> <span class="ss">platforms: :ruby</span>
  
  <span class="o">+</span> <span class="n">group</span> <span class="ss">:development</span> <span class="k">do</span>
  <span class="o">+</span>   <span class="n">gem</span> <span class="s1">'capistrano'</span><span class="p">,</span>         <span class="s1">'~&gt; 3.6.0'</span><span class="p">,</span> <span class="ss">require: </span><span class="kp">false</span>
  <span class="o">+</span>   <span class="n">gem</span> <span class="s1">'capistrano-rvm'</span><span class="p">,</span>     <span class="s1">'~&gt; 0.1'</span><span class="p">,</span>   <span class="ss">require: </span><span class="kp">false</span>
  <span class="o">+</span>   <span class="n">gem</span> <span class="s1">'capistrano-rails'</span><span class="p">,</span>   <span class="s1">'~&gt; 1.1.7'</span><span class="p">,</span> <span class="ss">require: </span><span class="kp">false</span>
  <span class="o">+</span>   <span class="n">gem</span> <span class="s1">'capistrano-bundler'</span><span class="p">,</span> <span class="s1">'~&gt; 1.1.4'</span><span class="p">,</span> <span class="ss">require: </span><span class="kp">false</span>
  <span class="o">+</span>   <span class="n">gem</span> <span class="s1">'capistrano3-puma'</span><span class="p">,</span>   <span class="s1">'~&gt; 1.2.1'</span><span class="p">,</span> <span class="ss">require: </span><span class="kp">false</span>
  <span class="o">+</span> <span class="k">end</span>
  
  <span class="o">+</span> <span class="n">group</span> <span class="ss">:production</span> <span class="k">do</span>
  <span class="o">+</span>   <span class="n">gem</span> <span class="s2">"mysql2"</span>
  <span class="o">+</span> <span class="k">end</span>
</code></pre></div></div>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>bundle <span class="nb">install</span>
<span class="nv">$ </span>cap <span class="nb">install</span>  
<span class="c"># =&gt; ask for installing other package? no</span>
</code></pre></div></div>

<p>2) 	modify Capfile</p>

<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Load DSL and set up stages</span>
<span class="nb">require</span> <span class="s2">"capistrano/setup"</span>
<span class="c1"># Include default deployment tasks</span>
<span class="nb">require</span> <span class="s2">"capistrano/deploy"</span>

<span class="nb">require</span> <span class="s1">'capistrano/rails'</span>
<span class="nb">require</span> <span class="s1">'capistrano/rvm'</span>
<span class="nb">require</span> <span class="s1">'capistrano/bundler'</span>
<span class="nb">require</span> <span class="s1">'capistrano/rails/assets'</span>
<span class="nb">require</span> <span class="s1">'capistrano/rails/migrations'</span>
<span class="nb">require</span> <span class="s1">'capistrano/puma'</span>

<span class="c1"># Load custom tasks from `lib/capistrano/tasks` if you have any defined</span>
<span class="no">Dir</span><span class="p">.</span><span class="nf">glob</span><span class="p">(</span><span class="s2">"lib/capistrano/tasks/*.rake"</span><span class="p">).</span><span class="nf">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">r</span><span class="o">|</span> <span class="n">import</span> <span class="n">r</span> <span class="p">}</span>
</code></pre></div></div>

<p>3) replace config/deploy.rb</p>

<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># config valid only for current version of Capistrano</span>

<span class="n">set</span> <span class="ss">:repo_url</span><span class="p">,</span>        <span class="s1">'git@github.com: YOUR_GIT_ACCOUNT/YOUR_PROJECT_NAME'</span>
<span class="n">set</span> <span class="ss">:application</span><span class="p">,</span>     <span class="s1">'YOUR_PROJECT_NAME'</span>
<span class="n">set</span> <span class="ss">:user</span><span class="p">,</span>            <span class="s1">'deploy'</span>
<span class="n">set</span> <span class="ss">:puma_threads</span><span class="p">,</span>    <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">16</span><span class="p">]</span>
<span class="n">set</span> <span class="ss">:puma_workers</span><span class="p">,</span>    <span class="mi">0</span>

<span class="c1"># Don't change these unless you know what you're doing</span>
<span class="n">set</span> <span class="ss">:pty</span><span class="p">,</span>             <span class="kp">true</span>
<span class="n">set</span> <span class="ss">:use_sudo</span><span class="p">,</span>        <span class="kp">false</span>
<span class="n">set</span> <span class="ss">:stage</span><span class="p">,</span>           <span class="ss">:production</span>
<span class="n">set</span> <span class="ss">:deploy_via</span><span class="p">,</span>      <span class="ss">:remote_cache</span>
<span class="n">set</span> <span class="ss">:deploy_to</span><span class="p">,</span>       <span class="s2">"/home/</span><span class="si">#{</span><span class="n">fetch</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span><span class="si">}</span><span class="s2">/</span><span class="si">#{</span><span class="n">fetch</span><span class="p">(</span><span class="ss">:application</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span>
<span class="n">set</span> <span class="ss">:puma_bind</span><span class="p">,</span>       <span class="s2">"unix://</span><span class="si">#{</span><span class="n">shared_path</span><span class="si">}</span><span class="s2">/tmp/sockets/</span><span class="si">#{</span><span class="n">fetch</span><span class="p">(</span><span class="ss">:application</span><span class="p">)</span><span class="si">}</span><span class="s2">-puma.sock"</span>
<span class="n">set</span> <span class="ss">:puma_state</span><span class="p">,</span>      <span class="s2">"</span><span class="si">#{</span><span class="n">shared_path</span><span class="si">}</span><span class="s2">/tmp/pids/puma.state"</span>
<span class="n">set</span> <span class="ss">:puma_pid</span><span class="p">,</span>        <span class="s2">"</span><span class="si">#{</span><span class="n">shared_path</span><span class="si">}</span><span class="s2">/tmp/pids/puma.pid"</span>
<span class="n">set</span> <span class="ss">:puma_access_log</span><span class="p">,</span> <span class="s2">"</span><span class="si">#{</span><span class="n">release_path</span><span class="si">}</span><span class="s2">/log/puma.error.log"</span>
<span class="n">set</span> <span class="ss">:puma_error_log</span><span class="p">,</span>  <span class="s2">"</span><span class="si">#{</span><span class="n">release_path</span><span class="si">}</span><span class="s2">/log/puma.access.log"</span>
<span class="n">set</span> <span class="ss">:ssh_options</span><span class="p">,</span>     <span class="p">{</span> <span class="ss">forward_agent: </span><span class="kp">true</span><span class="p">,</span> <span class="ss">user: </span><span class="n">fetch</span><span class="p">(</span><span class="ss">:user</span><span class="p">),</span> <span class="ss">keys: </span><span class="sx">%w(~/.ssh/id_rsa.pub)</span> <span class="p">}</span>
<span class="n">set</span> <span class="ss">:puma_preload_app</span><span class="p">,</span> <span class="kp">true</span>
<span class="n">set</span> <span class="ss">:puma_worker_timeout</span><span class="p">,</span> <span class="kp">nil</span>
<span class="n">set</span> <span class="ss">:puma_init_active_record</span><span class="p">,</span> <span class="kp">true</span>  <span class="c1"># Change to false when not using ActiveRecord</span>


<span class="c1">## Defaults:</span>

<span class="c1"># set :scm,           :git</span>
<span class="c1"># set :branch,        :master</span>
<span class="c1"># set :format,        :pretty</span>
<span class="c1"># set :log_level,     :debug</span>
<span class="c1"># set :keep_releases, 5</span>

<span class="c1">## Linked Files &amp; Directories (Default None):</span>
<span class="n">set</span> <span class="ss">:linked_files</span><span class="p">,</span> <span class="sx">%w{config/database.yml config/secrets.yml}</span>
<span class="n">set</span> <span class="ss">:linked_dirs</span><span class="p">,</span>  <span class="sx">%w{bin log tmp/pids tmp/cache tmp/sockets vendor/bundle public/system}</span>

<span class="n">namespace</span> <span class="ss">:puma</span> <span class="k">do</span>
  <span class="n">desc</span> <span class="s1">'Create Directories for Puma Pids and Socket'</span>
  <span class="n">task</span> <span class="ss">:make_dirs</span> <span class="k">do</span>
    <span class="n">on</span> <span class="n">roles</span><span class="p">(</span><span class="ss">:app</span><span class="p">)</span> <span class="k">do</span>
      <span class="n">execute</span> <span class="s2">"mkdir </span><span class="si">#{</span><span class="n">shared_path</span><span class="si">}</span><span class="s2">/tmp/sockets -p"</span>
      <span class="n">execute</span> <span class="s2">"mkdir </span><span class="si">#{</span><span class="n">shared_path</span><span class="si">}</span><span class="s2">/tmp/pids -p"</span>
    <span class="k">end</span>
  <span class="k">end</span>

	<span class="n">before</span> <span class="ss">:start</span><span class="p">,</span> <span class="ss">:make_dirs</span>
<span class="k">end</span>

<span class="n">namespace</span> <span class="ss">:deploy</span> <span class="k">do</span>
  <span class="n">desc</span> <span class="s2">"Make sure local git is in sync with remote."</span>
  <span class="n">task</span> <span class="ss">:check_revision</span> <span class="k">do</span>
    <span class="n">on</span> <span class="n">roles</span><span class="p">(</span><span class="ss">:app</span><span class="p">)</span> <span class="k">do</span>
      <span class="k">unless</span> <span class="sb">`git rev-parse HEAD`</span> <span class="o">==</span> <span class="sb">`git rev-parse origin/master`</span>
        <span class="nb">puts</span> <span class="s2">"WARNING: HEAD is not the same as origin/master"</span>
        <span class="nb">puts</span> <span class="s2">"Run `git push` to sync changes."</span>
      <span class="nb">exit</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="n">desc</span> <span class="s1">'Initial Deploy'</span>
  <span class="n">task</span> <span class="ss">:initial</span> <span class="k">do</span>
  <span class="n">on</span> <span class="n">roles</span><span class="p">(</span><span class="ss">:app</span><span class="p">)</span> <span class="k">do</span>
    <span class="n">before</span> <span class="s1">'deploy:restart'</span><span class="p">,</span> <span class="s1">'puma:start'</span>
    <span class="n">invoke</span> <span class="s1">'deploy'</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="n">desc</span> <span class="s1">'Restart application'</span>
  <span class="n">task</span> <span class="ss">:restart</span> <span class="k">do</span>
    <span class="n">on</span> <span class="n">roles</span><span class="p">(</span><span class="ss">:app</span><span class="p">),</span> <span class="ss">in: :sequence</span><span class="p">,</span> <span class="ss">wait: </span><span class="mi">5</span> <span class="k">do</span>
    <span class="n">invoke</span> <span class="s1">'puma:restart'</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="n">desc</span> <span class="s1">'Upload to shared/config'</span>
  <span class="n">task</span> <span class="ss">:upload</span> <span class="k">do</span>
  <span class="n">on</span> <span class="n">roles</span> <span class="p">(</span><span class="ss">:app</span><span class="p">)</span> <span class="k">do</span>
    <span class="n">upload!</span> <span class="s2">"config/database.yml"</span><span class="p">,</span> <span class="s2">"</span><span class="si">#{</span><span class="n">shared_path</span><span class="si">}</span><span class="s2">/config/database.yml"</span>
    <span class="n">upload!</span> <span class="s2">"config/secrets.yml"</span><span class="p">,</span>  <span class="s2">"</span><span class="si">#{</span><span class="n">shared_path</span><span class="si">}</span><span class="s2">/config/secrets.yml"</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="n">before</span> <span class="ss">:starting</span><span class="p">,</span>  <span class="ss">:check_revision</span>
<span class="n">after</span>  <span class="ss">:finishing</span><span class="p">,</span> <span class="ss">:compile_assets</span>
<span class="n">after</span>  <span class="ss">:finishing</span><span class="p">,</span> <span class="ss">:cleanup</span>
<span class="n">after</span>  <span class="ss">:finishing</span><span class="p">,</span> <span class="ss">:restart</span>
<span class="k">end</span>

<span class="n">desc</span> <span class="s2">"Run rake db:seed on a remote server."</span>
<span class="n">task</span> <span class="ss">:seed</span> <span class="k">do</span>
  <span class="n">on</span> <span class="n">roles</span> <span class="p">(</span><span class="ss">:app</span><span class="p">)</span> <span class="k">do</span>
    <span class="n">within</span> <span class="n">release_path</span> <span class="k">do</span>
      <span class="n">with</span> <span class="ss">rails_env: </span><span class="n">fetch</span><span class="p">(</span><span class="ss">:rails_env</span><span class="p">)</span> <span class="k">do</span>
      	<span class="n">execute</span> <span class="ss">:rake</span><span class="p">,</span> <span class="s2">"db:seed"</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="c1"># ps aux | grep puma    # Get puma pid</span>
<span class="c1"># kill -s SIGUSR2 pid   # Restart puma</span>
<span class="c1"># kill -s SIGTERM pid   # Stop puma</span>
</code></pre></div></div>

<p>4) modify config/deploy/production.rb</p>

<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">set</span> <span class="ss">:stage</span><span class="p">,</span> <span class="ss">:production</span>
<span class="n">set</span> <span class="ss">:branch</span><span class="p">,</span> <span class="ss">:master</span>

<span class="n">role</span> <span class="ss">:app</span><span class="p">,</span> <span class="sx">%w(deploy@xxx.xxx.xxx.xxx)</span>
<span class="n">role</span> <span class="ss">:web</span><span class="p">,</span> <span class="sx">%w(deploy@xxx.xxx.xxx.xxx)</span>
<span class="n">role</span> <span class="ss">:db</span><span class="p">,</span> <span class="sx">%w(deploy@xxx.xxx.xxx.xxx)</span>

<span class="n">set</span> <span class="ss">:rails_env</span><span class="p">,</span> <span class="s2">"production"</span>
<span class="n">set</span> <span class="ss">:puma_env</span><span class="p">,</span> <span class="s2">"production"</span>
<span class="n">set</span> <span class="ss">:puma_config_file</span><span class="p">,</span> <span class="s2">"</span><span class="si">#{</span><span class="n">shared_path</span><span class="si">}</span><span class="s2">/config/puma.rb"</span>
<span class="n">set</span> <span class="ss">:puma_conf</span><span class="p">,</span> <span class="s2">"</span><span class="si">#{</span><span class="n">shared_path</span><span class="si">}</span><span class="s2">/config/puma.rb"</span>
</code></pre></div></div>

<p>5) create config/nignx.conf</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	<span class="nx">upstream</span> <span class="nx">puma</span><span class="o">-</span><span class="nx">YOUR_PROJECT_NAME</span> <span class="p">{</span>
	  <span class="nx">server</span> <span class="nx">unix</span><span class="p">:</span><span class="c1">///home/deploy/YOUR_PROJECT_NAME/shared/tmp/sockets/YOUR_PROJECT_NAME-puma.sock;</span>
	
	<span class="p">}</span>
	
	<span class="nx">server</span> <span class="p">{</span>
	  <span class="nx">listen</span> <span class="mi">80</span> <span class="nx">default_server</span> <span class="nx">deferred</span><span class="p">;</span>
	  <span class="err">#</span> <span class="nx">server_name</span> <span class="nx">example</span><span class="p">.</span><span class="nx">com</span><span class="p">;</span>
	
	  <span class="nx">root</span> <span class="o">/</span><span class="nx">home</span><span class="o">/</span><span class="nx">deploy</span><span class="o">/</span><span class="nx">YOUR_PROJECT_NAME</span><span class="o">/</span><span class="nx">current</span><span class="o">/</span><span class="kr">public</span><span class="p">;</span>
	  <span class="nx">access_log</span> <span class="o">/</span><span class="nx">home</span><span class="o">/</span><span class="nx">deploy</span><span class="o">/</span><span class="nx">YOUR_PROJECT_NAME</span><span class="o">/</span><span class="nx">current</span><span class="o">/</span><span class="nx">log</span><span class="o">/</span><span class="nx">nginx</span><span class="p">.</span><span class="nx">access</span><span class="p">.</span><span class="nx">log</span><span class="p">;</span>
	  <span class="nx">error_log</span> <span class="o">/</span><span class="nx">home</span><span class="o">/</span><span class="nx">deploy</span><span class="o">/</span><span class="nx">YOUR_PROJECT_NAME</span><span class="o">/</span><span class="nx">current</span><span class="o">/</span><span class="nx">log</span><span class="o">/</span><span class="nx">nginx</span><span class="p">.</span><span class="nx">error</span><span class="p">.</span><span class="nx">log</span> <span class="nx">info</span><span class="p">;</span>
	
	  <span class="nx">location</span> <span class="o">^~</span> <span class="sr">/assets/</span> <span class="p">{</span>
	    <span class="nx">gzip_static</span> <span class="nx">on</span><span class="p">;</span>
	    <span class="nx">expires</span> <span class="nx">max</span><span class="p">;</span>
	    <span class="nx">add_header</span> <span class="nx">Cache</span><span class="o">-</span><span class="nx">Control</span> <span class="kr">public</span><span class="p">;</span>
	  <span class="p">}</span>
	
	  <span class="nx">try_files</span> <span class="nx">$uri</span><span class="o">/</span><span class="nx">index</span><span class="p">.</span><span class="nx">html</span> <span class="nx">$uri</span> <span class="p">@</span><span class="nd">puma</span><span class="p">;</span>
	  <span class="nx">location</span> <span class="p">@</span><span class="nd">puma</span> <span class="p">{</span>
	    <span class="nx">proxy_set_header</span> <span class="nx">X</span><span class="o">-</span><span class="nx">Forwarded</span><span class="o">-</span><span class="nx">For</span> <span class="nx">$proxy_add_x_forwarded_for</span><span class="p">;</span>
	    <span class="nx">proxy_set_header</span> <span class="nx">Host</span> <span class="nx">$http_host</span><span class="p">;</span>
	    <span class="nx">proxy_redirect</span> <span class="nx">off</span><span class="p">;</span>
	
	    <span class="nx">proxy_pass</span> <span class="na">http</span><span class="p">:</span><span class="c1">//puma-YOUR_PROJECT_NAME;</span>
	
	  <span class="p">}</span>
	
	  <span class="nx">error_page</span> <span class="mi">500</span> <span class="mi">502</span> <span class="mi">503</span> <span class="mi">504</span> <span class="o">/</span><span class="mi">500</span><span class="p">.</span><span class="nx">html</span><span class="p">;</span>
	  <span class="nx">client_max_body_size</span> <span class="mi">10</span><span class="nx">M</span><span class="p">;</span>
	  <span class="nx">keepalive_timeout</span> <span class="mi">10</span><span class="p">;</span>
	<span class="p">}</span>
</code></pre></div></div>

<p>6) modify .gitignore</p>

<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">+</span> <span class="sr">/config/</span><span class="n">database</span><span class="p">.</span><span class="nf">yml</span>
<span class="o">+</span> <span class="sr">/config/se</span><span class="n">crets</span><span class="p">.</span><span class="nf">yml</span>
</code></pre></div></div>

<ul>
  <li>copy to *.sample
    <ul>
      <li>config/database.yml -&gt; config/database.yml.sample</li>
      <li>config/secrets.yml -&gt; config/secrets.yml.sample</li>
    </ul>
  </li>
  <li>delete
    <ul>
      <li>config/database.yml</li>
      <li>config/secrets.yml</li>
    </ul>
  </li>
</ul>

<p>7) first commit</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ git add .
$ git commit -m "ready to deploy"
$ git push origin master
</code></pre></div></div>

<p>8) add ymls back and modify</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>* copy 
 - config/database.yml.sample -&gt; config/database.yml 
 - config/secrets.yml.sample -&gt; config/secrets.yml


config/database.yml
</code></pre></div></div>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  production:
  -  &lt;&lt;: <span class="k">*</span>default
  -  database: db/production.sqlite3
  +  adapter: mysql2
  +  encoding: utf8mb4
  +  database: YOUR_PROJECT_NAME
  +  pool: 5
  +  username: root
  +  password:
  +  socket: /var/run/mysqld/mysqld.sock
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>config/secrets.yml
</code></pre></div></div>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>-  secret_key_base: &lt;%<span class="o">=</span> ENV[<span class="s2">"SECRET_KEY_BASE"</span><span class="o">]</span> %&gt;
+  secret_key_base: e4a98dd1063a6765xxxxxxx <span class="c"># copy from development or test secret_key_base</span>
</code></pre></div></div>

<h2 id="first-deploy">First Deploy</h2>

<p>1) check deploy</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>cap production deploy:check
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>if it shows database.yml does not exist, don't worry about that. just go next step to copy yml.
</code></pre></div></div>

<p>2) upload database.yml and secrets.yml from ssh( not git )</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>cap production deploy:upload
</code></pre></div></div>

<p>3) initial deploy</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>cap production deploy:initial
</code></pre></div></div>

<p>4) rake db:seed</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>cap production seed
</code></pre></div></div>

<blockquote>
  <p>Normal deploy</p>
</blockquote>

<blockquote>

  <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ git add .
$ git commit -m "commit message"
$ git push origin master
$ cap production deploy	
</code></pre></div>  </div>
</blockquote>

<h2 id="open-your-website">Open your website</h2>

<p>open your site by ip</p>

<p>http://xxx.xxx.xxx.xxx</p>

<p>if failure, just ssh to Server for log</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>ssh deploy@xxx.xxx.xxx.xxx
<span class="nv">$ </span><span class="nb">tail</span> <span class="nt">-f</span> /home/deploy/YOUR_PROJECT_NAME/current/log/production.log
</code></pre></div></div>

<blockquote>
  <p>參考</p>
  <ol>
    <li><a href="https://github.com/kakas/CapistranoDeployTest">kakas/CapistranoDeployTest</a></li>
    <li>
      <table>
        <tbody>
          <tr>
            <td>[(Mini Course) Deploy Rails Project to Linux Server</td>
            <td>Growth School](http://courses.growthschool.com/courses/deploy-rails-project-to-linux-server)</td>
          </tr>
        </tbody>
      </table>
    </li>
    <li>
      <table>
        <tbody>
          <tr>
            <td>[Deploying a Rails App on Ubuntu 14.04 with Capistrano, Nginx, and Puma</td>
            <td>DigitalOcean](https://www.digitalocean.com/community/tutorials/deploying-a-rails-app-on-ubuntu-14-04-with-capistrano-nginx-and-puma)</td>
          </tr>
        </tbody>
      </table>
    </li>
  </ol>
</blockquote>

                
            </section>

            <footer class="page__meta">
                
                


                

  <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> 更新時間:</strong> <time class="dt-published" datetime="2016-08-08T03:07:00+08:00">August 8, 2016</time></p>

                
            </footer>

            <section class="page__share">
  
    <h4 class="page__share-title">分享到</h4>
  

  <a href="https://twitter.com/intent/tweet?via=anxgang1&text=%5BLinode%5D+Deploy+Rails+app+to+Linode+by+Capistrano+%28+Ubuntu+16.04%2Fnginx%2Fpuma%2FMySQL%2Frvm+%29%20https%3A%2F%2Fblog.anxgang.com%2Flinode-deploy-to-linode-by-capistrano-ubuntu-1604-nginx-puma-mysql-rvm%2F" class="btn btn--twitter" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="分享到 Twitter"><i class="fab fa-fw fa-twitter" aria-hidden="true"></i><span> Twitter</span></a>

  <a href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fblog.anxgang.com%2Flinode-deploy-to-linode-by-capistrano-ubuntu-1604-nginx-puma-mysql-rvm%2F" class="btn btn--facebook" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="分享到 Facebook"><i class="fab fa-fw fa-facebook" aria-hidden="true"></i><span> Facebook</span></a>

  <a href="https://www.linkedin.com/shareArticle?mini=true&url=https%3A%2F%2Fblog.anxgang.com%2Flinode-deploy-to-linode-by-capistrano-ubuntu-1604-nginx-puma-mysql-rvm%2F" class="btn btn--linkedin" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="分享到 LinkedIn"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span> LinkedIn</span></a>
</section>


            
  <nav class="pagination">
    
      <a href="/rails-link-to-and-button-to-discussion/" class="pagination--pager" title="[Rails] 關於 link_to 及 button_to 指定 method 的探討
">上一篇</a>
    
    
      <a href="/mssql-mac-environment-mssql-online-notes/" class="pagination--pager" title="[MSSQL] Rails MSSQL連線筆記
">下一篇</a>
    
  </nav>

        </div>

        
        <div class="page__comments">
  
  
      <h4 class="page__comments-title">留言</h4>
      <section id="disqus_thread"></section>
    
</div>

        
    </article>

    
    
    <div class="page__related">
        <h2 class="page__related-title">
            猜您有與趣</h2>
        <div class="grid__wrapper">
            
            



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
      <div class="archive__item-teaser">
        <img src="/assets/images/logo-linode.jpg" alt="">
      </div>
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/ubuntu/how-to-create-linodes-with-custom-iso/" rel="permalink">如何使用自定義的 iso 建立 Linode
</a>
      
    </h2>
    

  <p class="page__meta">
    
      
      <span class="page__meta-date">
        <i class="far fa-fw fa-calendar-alt" aria-hidden="true"></i>
        
         
        <time datetime="2023-02-04T00:00:00+08:00">2023-02-04</time>
      </span>
    

    <span class="page__meta-sep"></span>

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-fw fa-clock" aria-hidden="true"></i>
        
          少於 1 分鐘閱讀
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">如何使用自定義的 iso 建立 Linode
</p>
  </article>
</div>

            
            



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
      <div class="archive__item-teaser">
        <img src="/assets/images/logo-ubuntu.jpg" alt="">
      </div>
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/ubuntu/how-to-mount-windows-share-folder-in-ubuntu-copy/" rel="permalink">Ubuntu 如何 mount windows 的分享資料夾
</a>
      
    </h2>
    

  <p class="page__meta">
    
      
      <span class="page__meta-date">
        <i class="far fa-fw fa-calendar-alt" aria-hidden="true"></i>
        
         
        <time datetime="2023-02-02T00:00:00+08:00">2023-02-02</time>
      </span>
    

    <span class="page__meta-sep"></span>

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-fw fa-clock" aria-hidden="true"></i>
        
          1 分鐘閱讀
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">ubuntu 如何連接 windows 的分享資料夾
</p>
  </article>
</div>

            
            



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
      <div class="archive__item-teaser">
        <img src="/assets/images/logo-ubuntu.jpg" alt="">
      </div>
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/ubuntu/how-to-use-crontab-in-ubuntu/" rel="permalink">Ubuntu 如何使用排程 crontab
</a>
      
    </h2>
    

  <p class="page__meta">
    
      
      <span class="page__meta-date">
        <i class="far fa-fw fa-calendar-alt" aria-hidden="true"></i>
        
         
        <time datetime="2023-01-13T00:00:00+08:00">2023-01-13</time>
      </span>
    

    <span class="page__meta-sep"></span>

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-fw fa-clock" aria-hidden="true"></i>
        
          少於 1 分鐘閱讀
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">ubuntu 如何使用排程 crontab
</p>
  </article>
</div>

            
            



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
      <div class="archive__item-teaser">
        <img src="/assets/images/logo-jekyll.jpg" alt="">
      </div>
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/jekyll/drawing-flowcharts-with-mermaid-in-jekyll/" rel="permalink">Jekyll 使用 mermaid 繪製流程圖
</a>
      
    </h2>
    

  <p class="page__meta">
    
      
      <span class="page__meta-date">
        <i class="far fa-fw fa-calendar-alt" aria-hidden="true"></i>
        
         
        <time datetime="2023-01-08T00:00:00+08:00">2023-01-08</time>
      </span>
    

    <span class="page__meta-sep"></span>

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-fw fa-clock" aria-hidden="true"></i>
        
          2 分鐘閱讀
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">mermaid 是使用 JavaScript 開發的圖表工具。
他受到 Markdown 啟發，使用簡易的文字定義，即可動態建立圖表。
本文介紹如何將其嵌入 Jekyll 之中。
</p>
  </article>
</div>

            
            



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
      <div class="archive__item-teaser">
        <img src="/assets/images/logo-jekyll.jpg" alt="">
      </div>
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/jekyll/private-repo-with-gh-pages/" rel="permalink">Jekyll 使用 private repo 建立 gh-pages
</a>
      
    </h2>
    

  <p class="page__meta">
    
      
      <span class="page__meta-date">
        <i class="far fa-fw fa-calendar-alt" aria-hidden="true"></i>
        
         
        <time datetime="2023-01-04T00:00:00+08:00">2023-01-04</time>
      </span>
    

    <span class="page__meta-sep"></span>

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-fw fa-clock" aria-hidden="true"></i>
        
          1 分鐘閱讀
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">免費版的 github 建立 gh-pages 必須公開 repository。
如果想省錢又不想把 markdown 直接公諸於世該怎麼辦？
</p>
  </article>
</div>

            
            



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
      <div class="archive__item-teaser">
        <img src="/assets/images/logo-jekyll.jpg" alt="">
      </div>
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/linux-query-uses-the-pid-of-port/" rel="permalink">[Linux] 查詢佔用 port 的 pid
</a>
      
    </h2>
    

  <p class="page__meta">
    
      
      <span class="page__meta-date">
        <i class="far fa-fw fa-calendar-alt" aria-hidden="true"></i>
        
         
        <time datetime="2018-10-18T08:33:00+08:00">2018-10-18</time>
      </span>
    

    <span class="page__meta-sep"></span>

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-fw fa-clock" aria-hidden="true"></i>
        
          少於 1 分鐘閱讀
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">查詢佔用 port 的 pid

$ netstat -nlp|grep 8080


查詢 pid 佔用哪些 port

$ netstat -pl | grep 6152

</p>
  </article>
</div>

            
            



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
      <div class="archive__item-teaser">
        <img src="/assets/images/logo-jekyll.jpg" alt="">
      </div>
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/postal-self-built-a-large-number-of-mail-sent-to-the-server/" rel="permalink">[Postal] 自建大量寄送信件伺服器
</a>
      
    </h2>
    

  <p class="page__meta">
    
      
      <span class="page__meta-date">
        <i class="far fa-fw fa-calendar-alt" aria-hidden="true"></i>
        
         
        <time datetime="2018-10-16T09:22:00+08:00">2018-10-16</time>
      </span>
    

    <span class="page__meta-sep"></span>

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-fw fa-clock" aria-hidden="true"></i>
        
          1 分鐘閱讀
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">Postal

1. 開一台 Ubuntu 16.04 LTS
2. 執行快速安裝指令

$ curl https://raw.githubusercontent.com/atech/postal/master/script/install/ubuntu1604.sh | sh	


3. 開新帳號

$ pos...</p>
  </article>
</div>

            
            



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
      <div class="archive__item-teaser">
        <img src="/assets/images/logo-jekyll.jpg" alt="">
      </div>
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/rails-cookie-overflow-problem-handling/" rel="permalink">[Rails] cookie overflow 問題處理
</a>
      
    </h2>
    

  <p class="page__meta">
    
      
      <span class="page__meta-date">
        <i class="far fa-fw fa-calendar-alt" aria-hidden="true"></i>
        
         
        <time datetime="2018-09-06T00:57:00+08:00">2018-09-06</time>
      </span>
    

    <span class="page__meta-sep"></span>

    
      
      

      <span class="page__meta-readtime">
        <i class="far fa-fw fa-clock" aria-hidden="true"></i>
        
          少於 1 分鐘閱讀
        
      </span>
    
  </p>


    <p class="archive__item-excerpt" itemprop="description">錯誤訊息
ActionDispatch::Cookies::CookieOverflow in UsersController#create

解決方式
使用 active_record_store 或是 mem_record_store 把 cookie 內容另外存起來

本文使用 active_record_...</p>
  </article>
</div>

            
        </div>
    </div>
    
    
</div>


    </div>

    
      <div class="search-content">
        <div class="search-content__inner-wrap"><form class="search-content__form" onkeydown="return event.key != 'Enter';" role="search">
    <label class="sr-only" for="search">
      請輸入您要搜尋的關鍵詞...
    </label>
    <input type="search" id="search" class="search-input" tabindex="-1" placeholder="請輸入您要搜尋的關鍵詞..." />
  </form>
  <div id="results" class="results"></div></div>

      </div>
    

    <div id="footer" class="page__footer">
      <footer>
        <!-- start custom footer snippets -->
<script type="module">
  if (document.querySelector(".language-mermaid")) {
    import('https://cdn.jsdelivr.net/npm/mermaid@9/dist/mermaid.esm.min.mjs').then(mermaid => {
      // console.log("module mermaid is loaded")
      mermaid.default.init({noteMargin: 10}, ".language-mermaid")
    })
  }
</script>
<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    
      <li><strong>追蹤:</strong></li>
    

    
      
        
          <li><a href="https://twitter.com/anxgang1" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-twitter-square" aria-hidden="true"></i> Twitter</a></li>
        
      
        
          <li><a href="https://github.com/anxgang" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-github" aria-hidden="true"></i> GitHub</a></li>
        
      
    

    
      <li><a href="/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> RSS Feed</a></li>
    
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2024 anxgang. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div>

      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>




<script src="/assets/js/lunr/lunr.min.js"></script>
<script src="/assets/js/lunr/lunr-store.js"></script>
<script src="/assets/js/lunr/lunr-en.js"></script>




    
  <script>
    var disqus_config = function () {
      this.page.url = "https://blog.anxgang.com/linode-deploy-to-linode-by-capistrano-ubuntu-1604-nginx-puma-mysql-rvm/";  /* Replace PAGE_URL with your page's canonical URL variable */
      this.page.identifier = "/linode-deploy-to-linode-by-capistrano-ubuntu-1604-nginx-puma-mysql-rvm"; /* Replace PAGE_IDENTIFIER with your page's unique identifier variable */
    };
    (function() { /* DON'T EDIT BELOW THIS LINE */
      var d = document, s = d.createElement('script');
      s.src = 'https://blog-anxgang-com.disqus.com/embed.js';
      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
    })();
  </script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>


  





  </body>
</html>
